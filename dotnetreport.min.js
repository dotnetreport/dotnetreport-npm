// .Net Report Builder helper methods
// Ajax call wrapper function
function ajaxcall(a){let b=!0===a.noBlocking,c=window.abp||null;return $.blockUI&&!b&&$.blockUI({baseZ:500}),$.ajax({url:a.url,type:a.type||"GET",data:a.data,cache:a.cache||!1,dataType:a.dataType||"json",contentType:a.contentType||"application/json; charset=utf-8",headers:a.headers||{},async:!1!==a.async||a.async,beforeSend:function(b){if(c){let d=c.auth.getToken();d&&b.setRequestHeader("Authorization","Bearer "+d),"POST"==a.type&&b.setRequestHeader(c.security.antiForgery.tokenHeaderName,c.security.antiForgery.getToken())}}}).done(function(){$.unblockUI&&$.unblockUI(),a=null}).fail(function(b,c,d){$.unblockUI&&$.unblockUI(),a=null,b.responseJSON&&b.responseJSON.d&&(b.responseJSON=b.responseJSON.d);var e=b.responseJSON&&b.responseJSON.Message?"\n"+b.responseJSON.Message:"";"Conflict"==d?toastr.error("Conflict detected. Please ensure the record is not a duplicate and that it has no related records."+e):"Bad Request"==d?toastr.error("Validation failed for your request. Please make sure the data provided is correct."+e):"Unauthorized"==d?toastr.error("You are not authorized to make that request."+e):"Forbidden"==d?location.reload(!0):"Not Found"==d?toastr.error("Record not found."+e):"Internal Server Error"==d?toastr.error("The system was unable to complete your request. <br>Service Reponse: "+e):toastr.error(c+": "+e)})}// knockout binding extenders
ko.bindingHandlers.datepicker={init:function(a,b,c){//initialize datepicker with some optional options
var d=c().datepickerOptions||{};//handle the field changing
//handle disposal (if KO removes by the template binding)
$(a).datepicker(d),ko.utils.registerEventHandler(a,"change",function(){var c=b();c($(a).datepicker({dateFormat:"mm/dd/yyyy"}).val())}),ko.utils.domNodeDisposal.addDisposeCallback(a,function(){$(a).datepicker("destroy")})},//update the control when the view model changes
update:function(a,b){var c=ko.utils.unwrapObservable(b()),d=$(a).datepicker("getDate");0!=c-d&&$(a).datepicker("setDate",c)}},ko.bindingHandlers.fadeVisible={init:function(a,b){// Initially set the element to be instantly visible/hidden depending on the value
var c=b();$(a).toggle(ko.utils.unwrapObservable(c))},update:function(a,b){// Whenever the value subsequently changes, slowly fade the element in or out
var c=b();ko.utils.unwrapObservable(c)?$(a).fadeIn("slow"):$(a).hide()}},ko.bindingHandlers.checkedInArray={init:function(a,b){ko.utils.registerEventHandler(a,"click",function(){var c=ko.utils.unwrapObservable(b()),d=c.array,// don't unwrap array because we want to update the observable array itself
e=ko.utils.unwrapObservable(c.value),f=a.checked;ko.utils.addOrRemoveItem(d,e,f)})},update:function(a,b){var c=ko.utils.unwrapObservable(b()),d=ko.utils.unwrapObservable(c.array),e=ko.utils.unwrapObservable(c.value);a.checked=0<=ko.utils.arrayIndexOf(d,e)}},ko.bindingHandlers.select2={after:["options","value"],init:function(a,b){$(a).select2(ko.unwrap(b())),ko.utils.domNodeDisposal.addDisposeCallback(a,function(){$(a).select2("destroy")})},update:function(a,b,c){var d=c(),e=$(a).data("select2");if("value"in d){var f=""+ko.unwrap(d.value);(d.select2.multiple||a.multiple)&&f.constructor!==Array?e.val([f.split(",")]):e.val([f])}if("selectedOptions"in d&&0==e.val().length){var f=ko.unwrap(d.selectedOptions);(d.select2.multiple||a.multiple)&&f&&f.constructor==Array&&e.val([f])}}};function redirectToReport(a,b,c){b="undefined"==typeof b?{}:b,c="undefined"!=typeof c&&c;var d=document.createElement("form");return $(d).attr("id","reg-form").attr("name","reg-form").attr("action",a).attr("method","post").attr("enctype","multipart/form-data"),c&&$(d).attr("target","_blank"),$.each(b,function(a){$(d).append("<input type=\"text\" name=\""+a+"\" value=\""+escape(this)+"\" />")}),document.body.appendChild(d),d.submit(),document.body.removeChild(d),!1}function htmlDecode(a){var b=document.createElement("div");return b.innerHTML=a,0===b.childNodes.length?"":b.childNodes[0].nodeValue}
var manageViewModel=function(a){var b=this;b.keys={AccountApiKey:a.model.AccountApiKey,DatabaseApiKey:a.model.DatabaseApiKey},b.DataConnections=ko.observableArray([]),b.Tables=new tablesViewModel(a),b.Procedures=new proceduresViewModel(a),b.foundProcedures=ko.observableArray([]),b.searchProcedureTerm=ko.observable(""),b.Joins=ko.observableArray([]),b.currentConnectionKey=ko.observable(b.keys.DatabaseApiKey),b.canSwitchConnection=ko.computed(function(){return b.currentConnectionKey()!=b.keys.DatabaseApiKey}),b.switchConnection=function(){b.canSwitchConnection()&&bootbox.confirm("Are you sure you would like to switch your Database Connection?",function(a){a&&(window.location.href=window.location.pathname+"?"+$.param({databaseApiKey:b.currentConnectionKey()}))})},b.JoinFilters={primaryTable:ko.observable(),primaryField:ko.observable(),joinType:ko.observable(),joinTable:ko.observable(),joinField:ko.observable()},b.filteredJoins=ko.computed(function(){var a=b.JoinFilters.primaryTable(),c=b.JoinFilters.primaryField(),d=b.JoinFilters.joinType(),e=b.JoinFilters.joinTable(),f=b.JoinFilters.joinField(),g=b.Joins();return _.filter(g,function(b){return(!a||!b.JoinTable()||0<=b.JoinTable().DisplayName().toLowerCase().indexOf(a.toLowerCase()))&&(!c||!b.FieldName()||0<=b.FieldName().toLowerCase().indexOf(c.toLowerCase()))&&(!d||!b.JoinType()||0<=b.JoinType().toLowerCase().indexOf(d.toLowerCase()))&&(!e||!b.OtherTable()||0<=b.OtherTable().DisplayName().toLowerCase().indexOf(e.toLowerCase()))&&(!f||!b.JoinFieldName()||0<=b.JoinFieldName().toLowerCase().indexOf(f.toLowerCase()))})}),b.JoinTypes=["INNER","LEFT","LEFT OUTER","RIGHT","RIGHT OUTER"],b.editColumn=ko.observable(),b.isStoredProcColumn=ko.observable(),b.selectColumn=function(a,c){b.isStoredProcColumn(null),b.editColumn(c),b.isStoredProcColumn(a)},b.editParameter=ko.observable(),b.selectParameter=function(a){b.editParameter(a)},b.editAllowedRoles=ko.observable(),b.newAllowedRole=ko.observable(),b.selectAllowedRoles=function(a){b.editAllowedRoles(a)},b.removeAllowedRole=function(a){b.editAllowedRoles().AllowedRoles.remove(a)},b.addAllowedRole=function(){return!b.newAllowedRole()||0<_.filter(b.editAllowedRoles().AllowedRoles(),function(a){return a==b.newAllowedRole()}).length?void toastr.error("Please add a new unique Role"):void(b.editAllowedRoles().AllowedRoles.push(b.newAllowedRole()),b.newAllowedRole(null))},b.newDataConnection={Name:ko.observable(),ConnectionKey:ko.observable(),copySchema:ko.observable(!1),copyFrom:ko.observable()},b.addDataConnection=function(){return($(".form-group").removeClass("has-error"),!b.newDataConnection.Name())?($("#add-conn-name").closest(".form-group").addClass("has-error"),!1):b.newDataConnection.ConnectionKey()?(ajaxcall({url:a.addDataConnectionUrl,type:"POST",data:JSON.stringify({account:b.keys.AccountApiKey,dataConnect:b.newDataConnection.copySchema()?b.newDataConnection.copyFrom():b.keys.DatabaseApiKey,newDataConnect:b.newDataConnection.Name(),connectionKey:b.newDataConnection.ConnectionKey(),copySchema:b.newDataConnection.copySchema()})}).done(function(a){b.DataConnections.push({Id:a.Id,DataConnectName:b.newDataConnection.Name(),ConnectionKey:b.newDataConnection.ConnectionKey(),DataConnectGuid:a.DataConnectGuid}),b.newDataConnection.Name(""),b.newDataConnection.ConnectionKey(""),toastr.success("Data Connection added successfully"),$("#add-connection-modal").modal("hide")}),!0):($("#add-conn-key").closest(".form-group").addClass("has-error"),!1)},b.setupJoin=function(a){return a.JoinTable=ko.observable(),a.OtherTable=ko.observable(),a.originalField=a.FieldName,a.originalJoinField=a.JoinFieldName,a=ko.mapping.fromJS(a),a.OtherTables=ko.computed(function(){return $.map(b.Tables.model(),function(b){return null!=a.JoinTable()&&b.Id()==a.JoinTable().Id()||0>=b.Id()?null:b})}),a.OtherTable.subscribe(function(){a.FieldName(a.originalField()),a.JoinFieldName(a.originalJoinField())}),a.JoinTable.subscribe(function(){a.FieldName(a.originalField()),a.JoinFieldName(a.originalJoinField())}),a.DeleteJoin=function(){bootbox.confirm("Are you sure you would like to delete this Join?",function(c){c&&b.Joins.remove(a)})},a.JoinTable(_.filter(b.Tables.model(),function(b){return b.Id()==a.TableId()})[0]),a.OtherTable(_.filter(a.OtherTables(),function(b){return b.Id()==a.JoinedTableId()})[0]),a},b.LoadDataConnections=function(){ajaxcall({url:a.getDataConnectionsUrl,type:"POST",data:JSON.stringify({account:b.keys.AccountApiKey,dataConnect:b.keys.DatabaseApiKey})}).done(function(a){b.DataConnections(a),b.currentConnectionKey(b.keys.DatabaseApiKey)})},b.searchStoredProcedure=function(){return b.searchProcedureTerm()?void ajaxcall({url:"/Setup/SearchProcedure",type:"POST",data:JSON.stringify({value:b.searchProcedureTerm(),accountKey:b.keys.AccountApiKey,dataConnectKey:b.keys.DatabaseApiKey})}).done(function(a){_.forEach(a,function(a){_.forEach(a.Columns,function(a){a.DisplayName=ko.observable(a.DisplayName)}),_.forEach(a.Parameters,function(a){a.DisplayName=ko.observable(a.DisplayName),a.ParameterValue=ko.observable(a.ParameterValue)}),a.DisplayName=ko.observable(a.DisplayName)}),b.foundProcedures(a)}):void toastr.error("Please enter a term to search stored procs")},b.saveProcedure=function(c,d){var f=_.find(!0===d?b.foundProcedures():b.Procedures.savedProcedures(),function(a){return a.TableName===c}),g=ko.mapping.toJS(f,{ignore:["dataTable","deleteTable","JoinTable"]});return ajaxcall({url:a.saveProcUrl,type:"POST",data:JSON.stringify({model:g,account:b.keys.AccountApiKey,dataConnect:b.keys.DatabaseApiKey})}).done(function(a){return a?void(d&&(b.Procedures.savedProcedures.remove(_.find(b.Procedures.savedProcedures(),function(a){return a.TableName()===c})),f.Id=a,f=ko.mapping.fromJS(f),b.Procedures.setupProcedure(f),b.Procedures.savedProcedures.push(f)),toastr.success("Saved Procedure "+g.TableName)):(toastr.error("Error saving Procedure: "+a.Message),!1)}),!1},b.LoadJoins=function(){// Load and setup Relations
ajaxcall({url:a.getRelationsUrl,type:"POST",data:JSON.stringify({account:b.keys.AccountApiKey,dataConnect:b.keys.DatabaseApiKey})}).done(function(a){b.Joins($.map(a,function(a){return b.setupJoin(a)}))})},b.AddJoin=function(){b.Joins.push(b.setupJoin({TableId:0,JoinedTableId:0,JoinType:"INNER",FieldName:"",JoinFieldName:""}))},b.getJoinsToSave=function(){_.forEach(b.Joins(),function(a){a.TableId(a.JoinTable().Id()),a.JoinedTableId(a.OtherTable().Id())});var a=$.map(ko.mapping.toJS(b.Joins),function(a){return{DataConnectionId:a.DataConnectionId,RelationId:a.Id,TableId:a.TableId,JoinedTableId:a.JoinedTableId,JoinType:a.JoinType,FieldName:a.FieldName,JoinFieldName:a.JoinFieldName}});return a},b.SaveJoins=function(){var c=b.getJoinsToSave();ajaxcall({url:a.saveRelationsUrl,type:"POST",data:JSON.stringify({account:b.keys.AccountApiKey,dataConnect:b.keys.DatabaseApiKey,relations:c})}).done(function(a){"Success"==a&&toastr.success("Changes saved successfully.")})},b.saveChanges=function(){var a=$.map(b.Tables.model(),function(a){if(a.Selected())return a});return 0==a.length?void toastr.error("Please choose some tables and columns"):void bootbox.confirm("Are you sure you would like to continue with saving your changes?<br><b>Note: </b>This will make changes to your account that cannot be undone.",function(c){c&&_.forEach(a,function(a){a.saveTable(b.keys.AccountApiKey,b.keys.DatabaseApiKey)})})},b.download=function(b,c,d){var e=document.createElement("a"),a=new Blob([b],{type:d});e.href=URL.createObjectURL(a),e.download=c,e.click()},b.exportAll=function(){var a=$.map(b.Tables.model(),function(a){if(a.Selected())return ko.mapping.toJS(a,{ignore:["saveTable","JoinTable"]})}),c=b.getJoinsToSave(),d=JSON.stringify({tables:a,joins:c}),e=_.filter(b.DataConnections(),function(a,c){return c.DataConnectGuid==b.currentConnectionKey()});b.download(d,(0<e.length?e[0].DataConnectName:"dotnet-dataconnection-export")+".json","text/plain")},b.importingFile=ko.observable(!1),b.importCancel=function(){b.importingFile(!1)},b.importFile=function(a){var c=new FileReader;c.onload=function(a){var c=JSON.parse(a.target.result);_.forEach(c.tables,function(a){var c=_.filter(b.Tables.model(),function(b){return b.TableName().toLowerCase()==a.TableName.toLowerCase()});if(0<c.length)c[0];else;}),$("#import-file").val("")},c.readAsText(a),b.importingFile(!1)},b.importStart=function(){b.importingFile(!0)}},tablesViewModel=function(a){var b=this;b.model=ko.mapping.fromJS(a.model.Tables),_.forEach(b.model(),function(c){c.availableColumns=ko.computed(function(){return _.filter(c.Columns(),function(a){return 0<a.Id()&&a.Selected()})}),_.forEach(c.Columns(),function(a){var c=_.filter(b.model(),function(b){return b.TableName()==a.ForeignTable()});if(a.JoinTable=ko.observable(null!=c&&0<c.length?c[0]:null),a.JoinTable.subscribe(function(b){a.ForeignTable(b.TableName())}),c=_.filter(b.model(),function(b){return b.TableName()==a.ForeignParentTable()}),a.ForeignJoinTable=ko.observable(null!=c&&0<c.length?c[0]:null),a.ForeignJoinTable.subscribe(function(b){a.ForeignParentTable(b.TableName())}),a.restrictDateRangeFilter=ko.observable(""!=a.RestrictedDateRange()&&null!=a.RestrictedDateRange()),a.restrictDateRangeNumber=ko.observable(1),a.restrictDateRangeValue=ko.observable(),a.restrictDateRangeFilter()){var d=a.RestrictedDateRange().split(" ");a.restrictDateRangeNumber(d[0]),a.restrictDateRangeValue(d[1])}a.restrictDateRangeFilter.subscribe(function(b){b?a.RestrictedDateRange(a.restrictDateRangeNumber()+" "+a.restrictDateRangeValue()):a.RestrictedDateRange("")}),a.restrictDateRangeNumber.subscribe(function(){a.RestrictedDateRange(a.restrictDateRangeNumber()+" "+a.restrictDateRangeValue())}),a.restrictDateRangeValue.subscribe(function(){a.RestrictedDateRange(a.restrictDateRangeNumber()+" "+a.restrictDateRangeValue())})}),c.saveTable=function(b,d){var f=ko.mapping.toJS(c,{ignore:["saveTable","JoinTable","ForeignJoinTable"]});return c.Selected()?0==_.filter(f.Columns,function(a){return a.Selected}).length?void toastr.error("Cannot save table "+f.DisplayName+", no columns selected"):void ajaxcall({url:a.saveTableUrl,type:"POST",data:JSON.stringify({account:b,dataConnect:d,table:f})}).done(function(){toastr.success("Saved table "+f.DisplayName)}):void bootbox.confirm("Are you sure you would like to delete Table '"+f.DisplayName+"'?",function(c){c&&ajaxcall({url:a.deleteTableUrl,type:"POST",data:JSON.stringify({account:b,dataConnect:d,tableId:f.Id})}).done(function(){toastr.success("Deleted table "+f.DisplayName)})})}}),b.availableTables=ko.computed(function(){return _.filter(b.model(),function(a){return 0<a.Id()&&a.Selected()})}),b.tableFilter=ko.observable(),b.filteredTables=ko.computed(function(){var a=b.tableFilter();return null==a||""==a?b.model():_.filter(b.model(),function(b){return 0<=b.TableName().toLowerCase().indexOf(a.toLowerCase())})}),b.clearTableFilter=function(){b.tableFilter("")},b.selectAll=function(){_.forEach(b.model(),function(a){a.Selected()||(a.Selected(!0),_.forEach(a.Columns(),function(a){a.Selected(!0)}))})},b.unselectAll=function(){_.forEach(b.model(),function(a){a.Selected(!1),_.forEach(a.Columns(),function(a){a.Selected(!1)})})},b.selectAllColumns=function(a){_.forEach(a.Columns(),function(a){a.Selected(!0)})},b.unselectAllColumns=function(a){_.forEach(a.Columns(),function(a){a.Selected(!1)})},b.columnSorted=function(a){_.forEach(a.targetParent(),function(a){a.DisplayOrder(i)})}},proceduresViewModel=function(a){var b=this;b.savedProcedures=ko.mapping.fromJS(a.model.Procedures,{ignore:["TableName"]}),b.tables=a.model.Tables,b.setupProcedure=function(c){_.forEach(c.Parameters(),function(a){var c=_.filter(b.tables,function(b){return b.TableName==a.ForeignTable()});a.JoinTable=ko.observable(null!=c&&0<c.length?c[0]:null),a.JoinTable.subscribe(function(b){a.ForeignTable(b.TableName)}),a.ParameterValue.subscribe(function(b){b||a.Hidden(!1)})}),c.deleteTable=function(d,f){var g=ko.mapping.toJS(c);bootbox.confirm("Are you sure you would like to delete Procedure '"+g.TableName+"'? <br><br>WARNING: Deleting the stored procedure will also delete all Reports using this Stored Proc.",function(e){e&&ajaxcall({url:a.deleteProcUrl,type:"POST",data:JSON.stringify({procId:g.Id,account:d,dataConnect:f})}).done(function(){toastr.success("Deleted procedure "+g.TableName),b.savedProcedures.remove(c)})})}},_.forEach(b.savedProcedures(),function(a){b.setupProcedure(a)})};
/// dotnet Report Builder view model v4.2.6
/// License has to be purchased for use
/// 2018-2021 (c) www.dotnetreport.com
function pagerViewModel(e){e=e||{};var r=this;r.pageSize=ko.observable(e.pageSize||30),r.pages=ko.observable(e.pages||1),r.currentPage=ko.observable(e.currentPage||1),r.pauseNavigation=ko.observable(!1),r.totalRecords=ko.observable(0),r.sortColumn=ko.observable(),r.sortDescending=ko.observable(),r.isFirstPage=ko.computed(function(){var e=this;return 1==e.currentPage()},r),r.isLastPage=ko.computed(function(){var e=this;return e.currentPage()==e.pages()},r),r.currentPage.subscribe(function(e){e>r.pages()&&r.currentPage(0==r.pages()?1:r.pages()),1>e&&r.currentPage(1)}),r.previous=function(){r.pauseNavigation()||r.isFirstPage()||isNaN(r.currentPage())||r.currentPage(+r.currentPage()-1)},r.next=function(){r.pauseNavigation()||r.isLastPage()||isNaN(r.currentPage())||r.currentPage(+r.currentPage()+1)},r.first=function(){r.pauseNavigation()||r.currentPage(1)},r.last=function(){r.pauseNavigation()||r.currentPage(r.pages())},r.changeSort=function(e){r.sortColumn()==e?r.sortDescending(!r.sortDescending()):r.sortDescending(!1),r.sortColumn(e),1!=r.currentPage()&&r.currentPage(1)}}function formulaFieldViewModel(e){e=e||{};var r=this;r.fieldId=ko.observable(e.fieldId),r.isParenthesesStart=ko.observable(e.isParenthesesStart),r.isParenthesesEnd=ko.observable(e.isParenthesesEnd),r.formulaOperation=ko.observable(e.formulaOperation),r.isConstantValue=ko.observable(!!e.constantValue),r.constantValue=ko.observable(e.constantValue)}function linkFieldViewModel(e,r){e=e||{};var a=this,t=!0;// ui-validation
a.linkTypes=["Report","URL"],a.selectedLinkType=ko.observable(e.LinksToReport?"Report":"URL"),a.allFields=ko.observableArray([]),a.LinksToReport=ko.observable(e.LinksToReport||!1),a.LinkedToReportId=ko.observable(),a.SendAsFilterParameter=ko.observable(e.SendAsFilterParameter||!1),a.SelectedFilterId=ko.observable(e.SelectedFilterId),a.LinkToUrl=ko.observable(e.LinkToUrl),a.SendAsQueryParameter=ko.observable(e.SendAsQueryParameter||!1),a.QueryParameterName=ko.observable(e.QueryParameterName),a.toJs=function(){return{LinksToReport:a.LinksToReport(),LinkedToReportId:a.LinkedToReportId(),SendAsFilterParameter:a.SendAsFilterParameter(),SelectedFilterId:a.SelectedFilterId(),LinkToUrl:a.LinkToUrl(),SendAsQueryParameter:a.SendAsQueryParameter(),QueryParameterName:a.QueryParameterName()}},a.selectedLinkType.subscribe(function(){a.LinksToReport("Report"==a.selectedLinkType())}),a.LinkedToReportId.subscribe(function(o){if(o)return ajaxcall({url:r.apiUrl,data:{method:"/ReportApi/LoadReport",model:JSON.stringify({reportId:o})}}).done(function(r){r.d&&(r=r.d),r.UseStoredProc?a.allFields(_.map(r.SelectedParameters,function(e){return{fieldId:e.ParameterId,fieldName:e.ParameterName}})):a.allFields(r.SelectedFields),t&&a.LinksToReport()&&(a.SelectedFilterId(e.SelectedFilterId),t=!1)})}),a.LinksToReport()&&a.LinkedToReportId(e.LinkedToReportId),a.isInputValid=function(e){// first check for custom validation
return(null==$(e).attr("data-notempty")||0!=$(e).children("option").length)&&(e.validity?e.validity.valid:null==$(e).attr("required")||""!=$(e).val());// next try html5 validation if availble
// finally just check for required attr
},a.validateLink=function(){if(null!=r.linkModal){var e=r.linkModal.find("input,select"),t=!0;$(".needs-validation").removeClass("was-validated");for(var o=0;o<e.length;o++)$(e[o]).removeClass("is-invalid"),a.isInputValid(e[o])||(t=!1,$(".needs-validation").addClass("was-validated"),$(e[o]).addClass("is-invalid"));return t}},a.clear=function(){a.LinksToReport(!0),a.selectedLinkType("Report"),a.LinkedToReportId(null),a.SendAsFilterParameter(!1),a.SelectedFilterId(null),a.LinkToUrl=ko.observable(null),a.SendAsQueryParameter(!1),a.QueryParameterName(null)}}function scheduleBuilder(e){var r=this;r.options=["day","week","month","year","once"],r.showAtTime=ko.observable(!0),r.showDays=ko.observable(!1),r.showMonths=ko.observable(!1),r.showDates=ko.observable(!1),r.selectedOption=ko.observable("day"),r.selectedDays=ko.observableArray([]),r.selectedMonths=ko.observableArray([]),r.selectedDates=ko.observableArray([]),r.selectedHour=ko.observable("12"),r.selectedMinute=ko.observable("00"),r.selectedAmPm=ko.observable("PM"),r.selectedDate=ko.observable();r.days=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],r.months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],r.dates=[],r.hours=[],r.minutes=["00","15","30","45"];for(var a=1;31>=a;a++)r.dates.push(a);for(var a=1;12>=a;a++)r.hours.push(a);r.dates.push("Last day of the month"),r.hasSchedule=ko.observable(!1),r.emailTo=ko.observable(""),r.hasScheduleStart=ko.observable(!1),r.hasScheduleEnd=ko.observable(!1),r.scheduleStart=ko.observable(),r.scheduleEnd=ko.observable(),r.selectedOption.subscribe(function(e){r.selectedDays([]),r.selectedMonths([]),r.selectedDates([]);"once"===e||"day"===e?(r.showDays(!1),r.showDates(!1),r.showMonths(!1)):"week"===e?(r.showDays(!0),r.showDates(!1),r.showMonths(!1)):"month"===e?(r.showDays(!1),r.showDates(!0),r.showMonths(!1)):"year"===e?(r.showDays(!1),r.showDates(!0),r.showMonths(!0)):void 0}),r.toJs=function(){return r.hasSchedule()?{SelectedOption:r.selectedOption(),SelectedDays:r.selectedDays().join(","),SelectedMonths:r.selectedMonths().join(","),SelectedDates:"once"==r.selectedOption()?r.selectedDate():r.selectedDates().join(","),SelectedHour:r.selectedHour(),SelectedMinute:r.selectedMinute(),SelectedAmPm:r.selectedAmPm(),EmailTo:r.emailTo(),UserId:e,ScheduleStart:r.hasScheduleStart()?r.scheduleStart():"",ScheduleEnd:r.hasScheduleEnd()?r.scheduleEnd():""}:null},r.fromJs=function(e){r.hasSchedule(!!e),e=e||{SelectedOption:"day",SelectedDays:"",SelectedMonths:"",SelectedDates:""},r.selectedOption(e.SelectedOption),r.selectedDays(e.SelectedDays.split(",")),r.selectedMonths(e.SelectedMonths.split(",")),"once"==r.selectedOption()?r.selectedDate(e.SelectedDates):e.SelectedDates=="Last day of the month"?r.selectedDates([e.SelectedDates]):r.selectedDates(_.map(e.SelectedDates.split(","),function(e){return parseInt(e)})),r.selectedHour(e.SelectedHour||"12"),r.selectedMinute(e.SelectedMinute||"00"),r.selectedAmPm(e.SelectedAmPm||"PM"),r.emailTo(e.EmailTo||""),r.scheduleStart(e.ScheduleStart?new Date(1*e.ScheduleStart.match(/\d+/)[0]):""),r.scheduleEnd(e.ScheduleEnd?new Date(1*e.ScheduleEnd.match(/\d+/)[0]):""),r.hasScheduleStart(!!e.ScheduleStart),r.hasScheduleEnd(!!e.ScheduleEnd)},r.clear=function(){r.fromJs(null)}}function filterGroupViewModel(r){r=r||{};var a=this;a.isRoot=!(!0!==r.isRoot),a.AndOr=ko.observable(r.AndOr||" AND "),a.Filters=ko.observableArray([]),a.FilterGroups=ko.observableArray([]),a.AddFilterGroup=function(t){var e=new filterGroupViewModel({parent:r.parent,AndOr:t.AndOr,options:r.options});return a.FilterGroups.push(e),e},a.RemoveFilterGroup=function(e){a.FilterGroups.remove(e)},a.GetValuesInFilterGroupForFieldAndTable=function(e,r){var t=null;return _.forEach(a.Filters(),function(a){if(a.Field()&&a.Field().hasForeignKey&&a.Field().foreignTable==e&&a.Field().foreignKey==r)return t=a,!1}),t},a.AddFilter=function(t,o){function l(e,a){ajaxcall({url:r.options.apiUrl,data:{method:"/ReportApi/GetLookupList",model:JSON.stringify({fieldId:e,dataFilters:a})}}).done(function(e){e.d&&(e=e.d),ajaxcall({type:"POST",url:r.options.lookupListUrl,data:JSON.stringify({lookupSql:e.sql,connectKey:e.connectKey})}).done(function(e){e.d&&(e=e.d),d(e),0<c.length&&(m.ValueIn(c),c=[])})})}t=t||{};var d=ko.observableArray([]),s=ko.observableArray([]),i=new URL(window.location.href),n=i.searchParams.get("filterId"),p=i.searchParams.get("filterValue");n&&p&&t.FieldId==parseInt(n)&&(t.Value1=p,t.Operator="="),t.Value1&&d.push({id:t.Value1,text:t.Value1}),t.Value2&&d.push({id:t.Value2,text:t.Value2});var u=ko.observable(),c="in"==t.Operator||"not in"==t.Operator?(t.Value1||"").split(","):[],m={AndOr:ko.observable(o?" AND ":t.AndOr),Field:u,Operator:ko.observable(t.Operator),Value:ko.observable(t.Value1),Value2:ko.observable(t.Value2),ValueIn:ko.observableArray(c),LookupList:d,ParentList:s,ParentIn:ko.observableArray([]),Apply:ko.observable(null==t.Apply||t.Apply),IsFilterOnFly:!0===o,showParentFilter:ko.observable(!0)};m.Operator.subscribe(function(){m.Value(null),m.Value2(null)});var b=!0;return u.subscribe(function(e){if(b||m.Value(null),e&&e.hasForeignKey)if(e.hasForeignParentKey){m.ParentIn.subscribe(function(a){if(a&&0<a.length){var t=Object.assign({},r.options.dataFilters||{});t[e.foreignParentApplyTo]=a.join(),l(e.fieldId,t)}else l(e.fieldId,r.options.dataFilters)});var t=a.GetValuesInFilterGroupForFieldAndTable(e.foreignParentTable,e.foreignParentKeyField);t?(m.showParentFilter(!1),t.Value.subscribe(function(e){m.ParentIn(e?[e]:null)}),t.ValueIn.subscribe(function(e){m.ParentIn(e)}),m.ParentIn("="==t.Operator()?t.Value()?[t.Value()]:[]:t.ValueIn())):(ajaxcall({url:r.options.apiUrl,data:{method:"/ReportApi/GetLookupList",model:JSON.stringify({fieldId:e.fieldId,dataFilters:r.options.dataFilters,parentLookup:!0})}}).done(function(e){e.d&&(e=e.d),ajaxcall({type:"POST",url:r.options.lookupListUrl,data:JSON.stringify({lookupSql:e.sql,connectKey:e.connectKey})}).done(function(e){e.d&&(e=e.d),s(e)})}),l(e.fieldId,r.options.dataFilters))}else l(e.fieldId,r.options.dataFilters);e&&e.restrictedDateRange&&"DateTime"==e.fieldType&&(m.Value.subscribe(function(r){if(r&&"range"==m.Operator()&&!a.isRangeValid(r,e.restrictedDateRange)&&(toastr.error("Filter range is more than "+e.restrictedDateRange+". Please choose a shorter date range"),m.Value(null)),r&&"between"==m.Operator()){var t=m.Value2();a.isDate(r)&&a.isDate(t)&&!a.isBetweenValid(r,m.Value2(),e.restrictedDateRange)&&(toastr.error("Filter range is more than "+e.restrictedDateRange+". Please choose a shorter date range"),m.Value(null))}}),m.Value2.subscribe(function(r){var t=m.Value();a.isDate(t)&&a.isDate(r)&&"between"==m.Operator()&&!a.isBetweenValid(t,r,e.restrictedDateRange)&&(toastr.error("Filter range is more than "+e.restrictedDateRange+". Please choose a shorter date range"),m.Value2(null))}))}),t.FieldId&&u(r.parent.FindField(t.FieldId)),m.compareTo=ko.computed(function(){return u()?_.filter(r.parent.AdditionalSeries(),function(e){return e.Field().fieldId==u().fieldId}):[]}),a.Filters.push(m),b=!1,m},a.RemoveFilter=function(e){a.Filters.remove(e)},a.isRangeValid=function(e,r){if(!e||!r)return!1;var a=r.split(" "),t=parseInt(a[0]),o=a[1],l=!0;return"This Month To Date"==e?("Years"==o&&(l=!1),"Days"==o&&30>t&&(l=!1)):0<=e.indexOf("Month")&&("Years"==o&&(l=!1),"Days"==o&&30>t&&(l=!1)),"This Year To Date"==e?("Months"==o&&12>t&&(l=!1),"Days"==o&&365>t&&(l=!1)):0<=e.indexOf("Year")?("Months"==o&&12>t&&(l=!1),"Days"==o&&365<t&&(l=!1)):0<=e.indexOf("Week")?"Days"==o&&7>t&&(l=!1):"Last 30 Days"==e&&"Days"==o&&30>t&&(l=!1),l},a.isBetweenValid=function(e,r,a){var t=a.split(" "),o=parseInt(t[0]),l=t[1],d=(new Date(r)-new Date(e))/86400000,s=!0;return"Days"===l?s=d<o&&0<d:"Months"===l?s=d<30*o:"Years"===l?s=d<365*o:void 0,s},a.isDate=function(e){return!!e&&"Invalid Date"!==new Date(e)&&!isNaN(new Date(e))}}var manageAccess=function(e){return{clientId:ko.observable(),users:_.map(e.users||[],function(e){return{selected:ko.observable(!1),value:ko.observable(e.id?e.id:e),text:e.text?e.text:e}}),userRoles:_.map(e.userRoles||[],function(e){return{selected:ko.observable(!1),value:ko.observable(e.id?e.id:e),text:e.text?e.text:e}}),viewOnlyUsers:_.map(e.users||[],function(e){return{selected:ko.observable(!1),value:ko.observable(e.id?e.id:e),text:e.text?e.text:e}}),viewOnlyUserRoles:_.map(e.userRoles||[],function(e){return{selected:ko.observable(!1),value:ko.observable(e.id?e.id:e),text:e.text?e.text:e}}),deleteOnlyUsers:_.map(e.users||[],function(e){return{selected:ko.observable(!1),value:ko.observable(e.id?e.id:e),text:e.text?e.text:e}}),deleteOnlyUserRoles:_.map(e.userRoles||[],function(e){return{selected:ko.observable(!1),value:ko.observable(e.id?e.id:e),text:e.text?e.text:e}}),getAsList:function(e){var r="";return _.forEach(e,function(a){a.selected()&&(r+=(r?",":"")+a.value())}),r},setupList:function(e,r){_.forEach(e,function(a){0<=r.indexOf(a.value())?a.selected(!0):a.selected(!1)})},isDashboard:ko.observable(!(!0!=e.isDashboard))}},headerDesigner=function(e){function r(e){var r=t.canvas.getActiveObject();return r?r[e]||"":""}function a(e,r){var a=t.canvas.getActiveObject();a&&(a.set(e,r).setCoords(),t.canvas.renderAll())}var t=this;t.canvas=null,t.initiated=!1,t.selectedObject=ko.observable(),t.UseReportHeader=ko.observable(!(!0!==e.useReportHeader)),t.init=function(r){if(!t.initiated&&(t.initiated=!0,t.canvas=new fabric.Canvas(e.canvasId),!0!==r)){var a=t.canvas;t.objectProperties={fontFamily:ko.observable(),fontSize:ko.observable(),fontColor:ko.observable(),fontBackcolor:ko.observable(),textAlign:ko.observable(),fontBold:ko.observable(),fontItalic:ko.observable(),fontUnderline:ko.observable()},a.on("object:moving",function(e){var r=Math.min,a=Math.max,t=e.target;t.currentHeight>t.canvas.height||t.currentWidth>t.canvas.width||(t.setCoords(),(0>t.getBoundingRect().top||0>t.getBoundingRect().left)&&(t.top=a(t.top,t.top-t.getBoundingRect().top),t.left=a(t.left,t.left-t.getBoundingRect().left)),(t.getBoundingRect().top+t.getBoundingRect().height>t.canvas.height||t.getBoundingRect().left+t.getBoundingRect().width>t.canvas.width)&&(t.top=r(t.top,t.canvas.height-t.getBoundingRect().height+t.top-t.getBoundingRect().top),t.left=r(t.left,t.canvas.width-t.getBoundingRect().width+t.left-t.getBoundingRect().left)))}),a.on("selection:created",function(e){t.selectedObject(e),t.objectProperties.fontFamily(t.getFontFamily()),t.objectProperties.fontBold(t.getFontBold()),t.objectProperties.fontItalic(t.getFontItalic()),t.objectProperties.fontColor(t.getFontColor()),t.objectProperties.fontUnderline(t.getFontUnderline()),t.objectProperties.textAlign(t.getTextAlign())}),a.on("selection:cleared",function(){t.selectedObject(null)})}},t.resizeCanvas=function(r){var a=t.canvas;null==a||(r=isNaN(r)?$("#"+e.canvasId).parent().parent().width():r,100<r&&a.setWidth(r),a.renderAll())},t.dispose=function(){t.canvas&&(t.canvas.dispose(),t.initiated=!1)},t.saveCanvas=function(){var r=JSON.stringify(t.canvas.toJSON());return ajaxcall({url:e.apiUrl.replace("CallReportApi","PostReportApi"),type:"POST",data:JSON.stringify({method:"/ReportApi/SaveReportHeader",headerJson:r,useReportHeader:t.UseReportHeader()})}).done(function(e){e.d&&(e=e.d),toastr.success("Report Header changes saved")})},t.loadCanvas=function(r){var a=t.canvas;return ajaxcall({url:e.apiUrl,data:{method:"/ReportApi/GetReportHeader",model:JSON.stringify({})}}).done(function(e){e.d&&(e=e.d),t.UseReportHeader(e.useReportHeader),a.loadFromJSON(e.headerJson,a.renderAll.bind(a),function(e,a){!0===r&&a.set("selectable",!1)})})},t.addText=function(){t.canvas.add(new fabric.Textbox("Enter Text",{left:50,top:50,fontFamily:"arial",fontWeight:"",originX:"left",hasRotatingPoint:!0,centerTransform:!0,width:300}))},t.addLine=function(){t.canvas.add(new fabric.Line([50,100,300,100],{left:20,top:20,stroke:"#000000"}))},t.uploadImage=function(e){if(1024e3<e.size)return toastr.error("Max file size is 1MB. Please choose a smaller image file. "),!1;var r=new FileReader;r.onload=function(r){var e=new Image;e.src=r.target.result,e.onload=function(){var r=new fabric.Image(e);r.set({angle:0}),t.canvas.centerObject(r),t.canvas.add(r),t.canvas.renderAll()}},r.readAsDataURL(e)},t.remove=function(){var e=t.canvas;e.remove(e.getActiveObject())},t.getText=function(){return r("text")},t.setText=function(e){a("text",e)},t.getFontFamily=function(){return r("fontFamily").toLowerCase()},t.setFontFamily=function(r,t){a("fontFamily",t.currentTarget.value)},t.getFontBold=function(){return r("fontWeight").toLowerCase()},t.setFontBold=function(){a("fontWeight","bold"==r("fontWeight")?"":"bold")},t.getFontItalic=function(){return r("fontStyle").toLowerCase()},t.setFontItalic=function(){a("fontStyle","italic"==r("fontStyle")?"":"italic")},t.getFontColor=function(){return r("stroke")},t.setFontColor=function(r,t){a("stroke",t.currentTarget.value),a("fill",t.currentTarget.value)},t.getFontUnderline=function(){return r("underline").toLowerCase()},t.setFontUnderline=function(){a("underline",r("underline")?"":"underline")},t.getTextAlign=function(){return r("textAlign")},t.setTextAlign=function(r,t){a("textAlign",t.currentTarget.value.toLowerCase())}},reportViewModel=function(a){var t=this;// List of fields to show in First List to choose from
// List of fields selected by user in the First List
// List of fields selected to show in the Second List
// List of fields selected by user in the second list
// Folder selected in start
// Load saved reports
// ui-validation
a=a||{},a.userSettings=a.userSettings||{},a.userId=a.userSettings.currentUserId||"",a.users=a.userSettings.users,a.userRoles=a.userSettings.userRoles,t.currentUserId=a.userSettings.userId,t.currentUserRole=(a.userSettings.currentUserRoles||[]).join(),t.currentUserName=a.userSettings.currentUserName,t.allowAdmin=ko.observable(a.userSettings.allowAdminMode),t.userIdForSchedule=a.userSettings.userIdForSchedule||t.currentUserId,t.ChartData=ko.observable(),t.ReportName=ko.observable(),t.ReportType=ko.observable("List"),t.ReportDescription=ko.observable(),t.FolderID=ko.observable(),t.ReportID=ko.observable(),t.Tables=ko.observableArray([]),t.Procs=ko.observableArray([]),t.SelectedTable=ko.observable(),t.SelectedProc=ko.observable(),t.ChooseFields=ko.observableArray([]),t.ChosenFields=ko.observableArray([]),t.selectedTableFields=[],t.SelectedFields=ko.observableArray([]),t.SelectFields=ko.observableArray([]),t.SelectedField=ko.observable(),t.AdditionalSeries=ko.observableArray([]),t.ReportSeries="",t.IncludeSubTotal=ko.observable(!1),t.ShowUniqueRecords=ko.observable(!1),t.AggregateReport=ko.observable(!1),t.SortByField=ko.observable(),t.SortDesc=ko.observable(!1),t.EditFiltersOnReport=ko.observable(!1),t.UseReportHeader=ko.observable(!1),t.HideReportHeader=ko.observable(!1),t.FilterGroups=ko.observableArray(),t.FilterGroups.subscribe(function(e){e&&0==e.length&&t.FilterGroups.push(new filterGroupViewModel({isRoot:!0,parent:t,options:a}))}),t.addSortField=function(e,r){var a={sortByFieldId:ko.observable(e),sortDesc:ko.observable(!(!0!==r)),remove:function(){t.SortFields.remove(a)}};t.SortFields.push(a)},t.SortFields=ko.observableArray([]),t.FilterGroups([]),t.SaveReport=ko.observable(!0),t.ShowDataWithGraph=ko.observable(!0),t.ShowOnDashboard=ko.observable(!1),t.ReportMode=ko.observable(a.reportMode||"start"),t.Folders=ko.observableArray(),t.SavedReports=ko.observableArray([]),t.SelectedFolder=ko.observable(null),t.CanSaveReports=ko.observable(!0),t.CanManageFolders=ko.observable(!0),t.CanEdit=ko.observable(!0),t.useReportHeader=ko.observable(!1),t.fieldFormatTypes=["Auto","Number","Decimal","Currency","Percentage","Date","Date and Time","Time","String"],t.decimalFormatTypes=["Number","Decimal","Currency","Percentage"],t.dateFormatTypes=["Date","Date and Time","Time"],t.fieldAlignments=["Auto","Left","Right","Center"],t.designingHeader=ko.observable(!1),t.headerDesigner=new headerDesigner({canvasId:a.reportHeader,apiUrl:a.apiUrl}),t.initHeaderDesigner=function(){t.headerDesigner.init(),t.headerDesigner.loadCanvas(!1),t.designingHeader(!0)},t.ReportResult=ko.observable({HasError:ko.observable(!1),ReportDebug:ko.observable(!1),Exception:ko.observable(),Warnings:ko.observable(),ReportSql:ko.observable(),ReportData:ko.observable(null),SubTotals:ko.observableArray([])}),t.useStoredProc=ko.observable(!1),t.StoredProcId=ko.observable(),t.Parameters=ko.observableArray([]),t.showParameters=ko.observable(!0),t.pager=new pagerViewModel,t.currentSql=ko.observable(),t.currentConnectKey=ko.observable(),t.adminMode=ko.observable(!1),t.allExpanded=ko.observable(!1),t.pager.currentPage(1),t.x=ko.observable(0),t.y=ko.observable(0),t.width=ko.observable(3),t.height=ko.observable(2),t.columnDetails=ko.observableArray([]),t.useStoredProc.subscribe(function(){t.SelectedTable(null),t.SelectedProc(null),t.SelectedFields([]),t.clearReport()}),t.adminMode.subscribe(function(e){t.LoadAllSavedReports(),e?(t._cansavereports=t.CanSaveReports(),t.SaveReport(!0),t.CanSaveReports(!0)):t.CanSaveReports(t._cansavereports),localStorage&&localStorage.setItem("reportAdminMode",e)}),t.manageAccess=manageAccess(a),t.pager.currentPage.subscribe(function(){t.ExecuteReportQuery(t.currentSql(),t.currentConnectKey(),t.ReportSeries)}),t.pager.pageSize.subscribe(function(){t.ExecuteReportQuery(t.currentSql(),t.currentConnectKey(),t.ReportSeries)}),t.createNewReport=function(){t.clearReport(),t.ReportMode("generate")},t.ReportType.subscribe(function(e){"List"==e?t.AggregateReport(!1):t.AggregateReport(!0)}),t.setReportType=function(e){t.ReportType(e)},t.cancelCreateReport=function(){bootbox.confirm("Are you sure you would like to cancel editing this Report?",function(e){e&&(t.clearReport(),a.reportWizard.modal("hide"),t.ReportMode("start"))})},t.FlyFilters=ko.computed(function(){var e=[];return _.forEach(t.FilterGroups(),function(r){_.forEach(r.Filters(),function(r){r.IsFilterOnFly&&e.push(r)})}),e}),t.enabledFields=ko.computed(function(){return _.filter(t.SelectedFields(),function(e){return!e.disabled()})}),t.scheduleBuilder=new scheduleBuilder(t.userIdForSchedule),t.ManageFolder={FolderName:ko.observable(),IsNew:ko.observable(!1),newFolder:function(){t.ManageFolder.IsNew(!0),t.ManageFolder.FolderName(""),$("#folderModal").modal("show")},editFolder:function(){return null==t.SelectedFolder()?void toastr.error("Please choose a folder first"):0==t.SelectedFolder().Id?void toastr.error("Cannot edit Default folder"):void(t.ManageFolder.IsNew(!1),t.ManageFolder.FolderName(t.SelectedFolder().FolderName),$("#folderModal").modal("show"))},saveFolder:function(){if(""==t.ManageFolder.FolderName())return void toastr.error("Please enter a Folder Name");var e=t.ManageFolder.IsNew()?0:t.SelectedFolder().Id;return 0==_.filter(t.Folders(),function(r){return r.FolderName.toLowerCase()==t.ManageFolder.FolderName().toLowerCase()&&(0==e||0!=e&&r.Id!=e)}).length?void ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/SaveFolder",model:JSON.stringify({folderId:e,folderName:t.ManageFolder.FolderName()})}}).done(function(e){if(e.d&&(e=e.d),t.ManageFolder.IsNew())t.Folders.push({Id:e,FolderName:t.ManageFolder.FolderName()});else{var r=t.SelectedFolder();t.Folders.remove(t.SelectedFolder()),r.FolderName=t.ManageFolder.FolderName(),t.Folders.push(r)}$("#folderModal").modal("hide")}):(toastr.error("Folder name is already in use, please choose a different Folder Name"),!1)},deleteFolder:function(){return null==t.SelectedFolder()?void toastr.error("Please choose a folder first"):0==t.SelectedFolder().Id?void toastr.error("Cannot delete Default folder"):void bootbox.confirm("Are you sure you want to delete this Folder?\n\nWARNING: Deleting a folder will delete all reports in the folder and this action cannot be undone.",function(e){e&&ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/DeleteFolder",model:JSON.stringify({folderId:t.SelectedFolder().Id})}}).done(function(){t.Folders.remove(t.SelectedFolder()),t.SelectedFolder(null)})})}},t.reportsInFolder=ko.computed(function(){return null==t.SelectedFolder()?[]:_.filter(t.SavedReports(),function(e){return e.folderId==t.SelectedFolder().Id})}),t.clearReport=function(){t.ReportName(""),t.ReportDescription(""),t.ReportType("List"),t.FolderID(null==t.SelectedFolder()?0:t.SelectedFolder().Id),t.ChosenFields([]),t.SelectedFields([]),t.SelectFields([]),t.SelectedField(null),t.SelectedProc(null),t.SelectedTable(null),t.IncludeSubTotal(!1),t.EditFiltersOnReport(!1),t.ShowUniqueRecords(!1),t.AggregateReport(!1),t.SortByField(null),t.SortDesc(!1),t.FilterGroups([]),t.ReportID(0),t.SaveReport(t.CanSaveReports()),t.scheduleBuilder.clear(),t.SortFields([]),t.isFormulaField(!1)},t.SelectedProc.subscribe(function(r){if(null!=r){t.ChooseFields([]),t.SelectedFields([]),t.selectedTableFields=[];var o=_.filter(r.Columns,function(e){return!1==e.DoNotDisplay}),l=_.map(o,function(a){var e=ko.toJS(r.SelectedFields&&r.SelectedFields.length?_.find(r.SelectedFields,{fieldName:a.DisplayName}):null),o=e||t.getEmptyFormulaField();return o.fieldName=a.DisplayName,o.tableName=r.DisplayName,o.procColumnId=a.Id,o.procColumnName=a.ColumnName,t.setupField(o)});r.SelectedFields=null,t.SelectedFields(l);var d=!0,s=_.map(r.Parameters,function(t){var e=ko.toJS(r.SelectedParameters&&r.SelectedParameters.length?_.find(r.SelectedParameters,{ParameterName:t.ParameterName}):null);return t.operators=["="],t.ParameterValue&&t.operators.push("is default"),t.Required||t.operators.push("is blank"),t.Required||t.operators.push("is null"),t.Operator?(t.Operator(e?e.Operator:"="),t.Value(e?e.Value:t.ParameterValue)):(t.Operator=ko.observable(e?e.Operator:"="),t.Value=ko.observable(e?e.Value:t.ParameterValue),t.Operator.subscribe(function(e){"is default"==e&&t.Value(t.ParameterValue)})),t.Field={hasForeignKey:t.ForeignKey,fieldType:t.ParameterDataTypeString,hasForeignParentKey:!1},t.LookupList=ko.observableArray([]),t.Value()&&t.LookupList.push({id:t.Value(),text:t.Value()}),t.ForeignKey&&ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/GetPrmLookupList",model:JSON.stringify({parameterId:t.Id,procId:r.Id,dataFilters:a.dataFilters})}}).done(function(e){e.d&&(e=e.d),ajaxcall({type:"POST",url:a.lookupListUrl,data:JSON.stringify({lookupSql:e.sql,connectKey:e.connectKey})}).done(function(e){e.d&&(e=e.d),t.LookupList(e)})}),t.Hidden||(d=!1),t});r.SelectedParameters=null,t.Parameters(s),t.showParameters(!d)}}),t.FindInFilterGroup=function(e){var r=!1;return _.forEach(t.FilterGroups(),function(a){_.forEach(a.Filters(),function(a){if(a.Field()&&(a.Field().FieldId==e||a.Field().fieldId==e))return r=!0,!1})}),r},t.SelectedFields.subscribe(function(e){var r=0<e.length?e[e.length-1]:null;if(r&&(r.forceFilter||r.forceFilterForTable)&&!t.FindInFilterGroup(r.fieldId)){var a=t.FilterGroups()[0],o=a.AddFilter();setTimeout(function(){r.forced=!0,o.Field(r)},500)}if(r){// go through and see if we need to add forced by Table filters
var l=_.filter(t.selectedTableFields,function(e){return!0==e.forceFilterForTable}),d=_.filter(t.selectedTableFields,function(e){return!1==e.forceFilterForTable}).map(function(e){return e.fieldId}),s=_.find(e,function(e){return 0<=d.indexOf(e.fieldId)});if(null==s||0==l.length)return;for(var n=0;n<l.length;n++){var p=l[n],u=_.find(t.SelectedFields(),function(e){return e.fieldId==p.fieldId});u||(p.disabled(!0),t.SelectedFields.push(p))}}}),t.loadTableFields=function(r){return ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/GetFields",model:JSON.stringify({tableId:r.tableId,includeDoNotDisplay:!1})}}).done(function(e){e.d&&(e=e.d);var a=_.map(e,function(a){var e=_.filter(t.SelectedFields(),function(e){return e.fieldId==a.fieldId});return 0<e.length?e[0]:(a.tableName=r.tableName,t.setupField(a))});t.ChooseFields(a),t.selectedTableFields=a})},t.SelectedTable.subscribe(function(e){return t.SelectedProc(null),null==e?(t.ChooseFields([]),void(t.selectedTableFields=[])):t.loadTableFields(e);// Get fields for Selected Table
}),t.MoveChosenFields=function(){// Move chosen fields to selected fields
_.forEach(t.ChosenFields(),function(r){0<_.filter(t.SelectedFields(),function(e){return e.fieldId==r.fieldId}).length?toastr.error(r.fieldName+" is already Selected"):t.SelectedFields.push(r)})},t.MoveAllFields=function(){// Move chosen fields to selected fields
_.forEach(t.ChooseFields(),function(r){0===_.filter(t.SelectedFields(),function(e){return e.fieldId==r.fieldId}).length&&t.SelectedFields.push(r)})},t.RemoveSelectedFields=function(){_.forEach(t.ChooseFields(),function(r){t.SelectedFields.remove(r)})},t.isFormulaField=ko.observable(!1),t.formulaFields=ko.observableArray([]),t.formulaFieldLabel=ko.observable(""),t.formulaDataFormat=ko.observable(""),t.formulaDecimalPlaces=ko.observable(),t.formulaOnlyHasDateFields=ko.computed(function(){var e=t.formulaFields();if(0>=e.length)return!1;var r=!0;return _.forEach(e,function(e){if(!e.setupFormula.isParenthesesStart()&&!e.setupFormula.isParenthesesEnd()&&!e.setupFormula.isConstantValue()&&e.fieldType&&0>e.fieldType.indexOf("Date"))return r=!1,!1}),r}),t.formulaFields.subscribe(function(e){if(e){var r=t.formulaOnlyHasDateFields();r&&0>["Days","Hours","Minutes","Seconds"].indexOf(t.formulaDataFormat())&&t.formulaDataFormat("Days"),!r&&0>["String","Integer","Double"].indexOf(t.formulaDataFormat())&&t.formulaDataFormat("String")}}),t.formulaHasConstantValue=ko.computed(function(){var e=t.formulaFields();if(0>=e.length)return!1;var r=!1;return _.forEach(e,function(e){if(!e.setupFormula.isParenthesesStart()&&!e.setupFormula.isParenthesesEnd()&&e.setupFormula.isConstantValue())return r=!0,!1}),r}),t.getEmptyFormulaField=function(){return{tableName:"Custom",fieldName:t.formulaFieldLabel()||"Custom",fieldFormat:t.formulaDataFormat()||"String",decimalPlaces:t.formulaDecimalPlaces(),fieldType:"Custom",aggregateFunction:"",filterOnFly:!1,disabled:!1,groupInGraph:!1,dontSubTotal:!1,hideInDetail:!1,linkField:!1,linkFieldItem:null,fieldAggregate:["Group","Count"],fieldAggregateWithDrilldown:["Group","Count"],isFormulaField:!0,hasForeignKey:!1,fieldFilter:["=","<>",">=",">","<","<="],formulaItems:t.formulaFields(),forceFilterForTable:!1}},t.selectedFieldsCanFilter=ko.computed(function(){return _.filter(t.SelectedFields(),function(e){return!e.isFormulaField()})}),t.clearFormulaField=function(){t.formulaFields([]),t.formulaFieldLabel(""),t.formulaDataFormat("String"),t.formulaDecimalPlaces(null)},t.isFormulaField.subscribe(function(){t.clearFormulaField()}),t.saveFormulaField=function(){if(0==t.formulaFields().length)return void toastr.error("Please select some items for the Custom Field");if(!t.validateReport())return void toastr.error("Please correct validation issues");var e=t.getEmptyFormulaField();t.SelectedFields.push(t.setupField(e)),t.clearFormulaField(),t.isFormulaField(!1)},t.showFormulaOperation=function(e){var r=t.formulaFields().length;return!(1>=r||e==r-1)&&!(t.formulaFields()[e+1].setupFormula.isParenthesesEnd()||t.formulaFields()[e].setupFormula.isParenthesesStart())},t.isConstantOperation=function(e){var r=t.formulaFields().length;return!(1>=r||e==r-1||e==r)&&t.formulaFields()[e+1].setupFormula.isConstantValue()},t.addFormulaParentheses=function(){if(!(0>=t.formulaFields().length)&&!(t.formulaFields()[0].setupFormula.isParenthesesStart()&&t.formulaFields()[t.formulaFields().length-1].setupFormula.isParenthesesEnd())){var e=t.getEmptyFormulaField(),r=t.setupField(Object.assign({},e)),a=t.setupField(Object.assign({},e));r.setupFormula.isParenthesesStart(!0),a.setupFormula.isParenthesesEnd(!0),t.formulaFields.splice(0,0,r),t.formulaFields.push(a)}},t.addFormulaConstantValue=function(){var e=t.getEmptyFormulaField(),r=t.setupField(Object.assign({},e));r.setupFormula.isConstantValue(!0),t.formulaFields.push(r)},t.isFieldValidForYAxis=function(e,r,a){return!(0<e&&"Bar"==t.ReportType()&&0>["Int","Double","Money"].indexOf(r)&&"Count"!=a)},t.isChart=ko.computed(function(){return 0>["List","Summary","Single"].indexOf(t.ReportType())}),t.isFieldValidForSubGroup=function(e,r){return!(0<e&&0>["Int","Double","Money"].indexOf(r))},t.canDrilldown=ko.computed(function(){return 0>["List"].indexOf(t.ReportType())}),t.dateFields=ko.computed(function(){return _.filter(t.SelectedFields(),function(e){return"DateTime"==e.fieldType})}),t.TotalSeries=ko.observable(0),t.AllSqlQuries=ko.observable(""),t.canAddSeries=ko.computed(function(){var e=0<t.dateFields().length&&0<=["Group","Bar","Line"].indexOf(t.ReportType())&&"DateTime"==t.SelectedFields()[0].fieldType,r=0<_.filter(t.FilterGroups(),function(e){return 0<_.filter(e.Filters(),function(e){return"range"==e.Operator()&&e.Value()&&0==e.Value().indexOf("This")}).length}).length;return e&&r}),t.canAddSeries.subscribe(function(e){e||t.AdditionalSeries([])}),t.AddSeries=function(r){function a(e){"This Year"===e?l(["Last Year","2 Years ago","3 Years ago","4 Years ago","5 Years ago"]):"This Month"===e?l(["Last Month","2 Months ago","3 Months ago","4 Months ago","5 Months ago"]):"This Week"===e?l(["Last Week","2 Weeks ago","3 Weeks ago","4 Weeks ago","5 Weeks ago"]):l([])}r=r||{};var o=ko.observable();r.Field?o(t.FindField(r.Field().fieldId)):o(t.dateFields()[0]);var l=ko.observableArray([]);_.forEach(t.FilterGroups(),function(e){_.forEach(e.Filters(),function(e){if(e.Field().FieldId==o().FieldId)return a(e.Value()),e.Value.subscribe(function(e){a(e)}),!1})}),t.AdditionalSeries.push({Field:o,Operator:ko.observable("Range"),Value:ko.observable(r.Value),Range:l})},t.canMoveUp=function(){// can move up only if one item is selected and it's not at the top
return!!(1==t.SelectFields().length&&1<=t.SelectedFields.indexOf(t.SelectFields()[0]))},t.canMoveDown=function(){// can move up only if one item is selected and it's not at the top
return!!(1==t.SelectFields().length&&t.SelectedFields.indexOf(t.SelectFields()[0])<t.SelectedFields().length-1)},t.MoveUp=function(){if(t.canMoveUp()){var e=t.SelectFields()[0],r=t.SelectedFields.indexOf(e);if(1<=r){var a=t.SelectedFields();t.SelectedFields.splice(r-1,2,a[r],a[r-1])}}},t.MoveDown=function(){if(t.canMoveDown()){var e=t.SelectFields()[0],r=t.SelectedFields.indexOf(e),a=t.SelectedFields();r<a.length-1&&t.SelectedFields.splice(r,2,a[r+1],a[r])}},t.RemoveField=function(e){var r=t.SelectedTable(),a=_.find(t.Tables(),{tableName:e.tableName});e.isFormulaField()||null!=r&&a.tableId==r.tableId?t.SelectedFields.remove(e):t.loadTableFields(a).done(function(){t.ChooseFields([]),t.SelectedFields.remove(e)})},t.RemoveSeries=function(e){t.AdditionalSeries.remove(e)},t.FindField=function(e){return _.filter(t.SelectedFields(),function(r){return r.fieldId==e})[0]},t.SaveWithoutRun=function(){t.RunReport(!0)},t.BuildFilterData=function(e){var r=[];return _.forEach(e,function(a){var o=[];_.forEach(a.Filters(),function(r,e){var l=r.Apply()&&r.IsFilterOnFly||!r.IsFilterOnFly?{SavedReportId:t.ReportID(),FieldId:r.Field().fieldId,AndOr:0==e?a.AndOr():r.AndOr(),Operator:r.Operator(),Value1:"in"==r.Operator()||"not in"==r.Operator()?r.ValueIn().join(","):0<=r.Operator().indexOf("blank")?"blank":r.Value(),Value2:r.Value2(),Filters:0==e?t.BuildFilterData(a.FilterGroups()):[]}:null;null==l||l.Value1||l.Value2||(l=null),l&&o.push(l)}),r.push({SavedReportId:t.ReportID(),isRoot:a.isRoot,AndOr:a.AndOr(),Filters:o})}),r},t.SeriesDataIntoFilter=function(e,r){var a=[];return _.forEach(e,function(o){var e=[t.AdditionalSeries()[r]],l=[];_.forEach(e,function(r,e){var a={SavedReportId:t.ReportID(),FieldId:r.Field().fieldId,AndOr:"AND",Operator:r.Operator().toLowerCase(),Value1:"in"==r.Operator()||"not in"==r.Operator()?r.ValueIn().join(","):0<=r.Operator().indexOf("blank")?"blank":r.Value(),Filters:0==e?t.BuildFilterData(o.FilterGroups()):[]};null==a||a.Value1||a.Value2||(a=null),a&&l.push(a)}),a.push({SavedReportId:t.ReportID(),isRoot:o.isRoot,AndOr:o.AndOr(),Filters:l})}),a},t.BuildReportData=function(e,r,o){e=e||[];var l=null!=_.find(t.SelectedFields(),function(e){return"Group in Detail"==e.selectedAggregate()}),d=r?t.SeriesDataIntoFilter(t.FilterGroups(),o):t.BuildFilterData(t.FilterGroups());return{ReportID:t.ReportID(),ReportName:t.ReportName(),ReportDescription:t.ReportDescription(),FolderID:t.FolderID(),SelectedFieldIDs:_.map(t.SelectedFields(),function(e){return e.fieldId}),Filters:d,Series:_.map(t.AdditionalSeries(),function(r){return{SavedReportId:t.ReportID(),FieldId:r.Field().fieldId,Operator:r.Operator(),Value:r.Value()}}),IncludeSubTotals:t.IncludeSubTotal(),EditFiltersOnReport:t.EditFiltersOnReport(),ShowUniqueRecords:t.ShowUniqueRecords(),IsAggregateReport:(!(0<e.length)||l)&&t.AggregateReport(),ShowDataWithGraph:t.ShowDataWithGraph(),ShowOnDashboard:t.ShowOnDashboard(),SortBy:t.SortByField(),SortDesc:t.SortDesc(),SelectedSorts:_.map(t.SortFields(),function(e){return{FieldId:e.sortByFieldId(),Descending:e.sortDesc()}}),ReportType:t.ReportType(),UseStoredProc:t.useStoredProc(),StoredProcId:t.useStoredProc()?t.SelectedProc().Id:null,GroupFunctionList:_.map(t.SelectedFields(),function(e){return{FieldID:e.fieldId,GroupFunc:e.selectedAggregate(),FilterOnFly:e.filterOnFly(),Disabled:e.disabled(),GroupInGraph:e.groupInGraph(),DontSubTotal:e.dontSubTotal(),HideInDetail:e.hideInDetail(),IsCustom:e.isFormulaField(),CustomLabel:e.fieldName,DataFormat:"None"==e.fieldFormat()?null:e.fieldFormat(),CustomFieldDetails:_.map(e.formulaItems(),function(e){return{FieldId:e.fieldId(),IsParenthesesStart:e.isParenthesesStart()||!1,IsParenthesesEnd:e.isParenthesesEnd()||!1,Operation:e.formulaOperation(),ConstantValue:e.constantValue()}}),LinkField:e.linkField(),LinkFieldItem:e.linkField()?e.linkFieldItem.toJs():null,FieldLabel:e.fieldLabel(),DecimalPlaces:e.decimalPlaces(),FieldAlign:e.fieldAlign(),FontColor:e.fontColor(),BackColor:e.backColor(),HeaderFontColor:e.headerFontColor(),HeaderBackColor:e.headerBackColor(),FontBold:e.fontBold(),HeaderFontBold:e.headerFontBold(),FieldWidth:e.fieldWidth(),FieldConditionOp:e.fieldConditionOp(),FieldConditionVal:e.fieldConditionVal()}}),Schedule:t.scheduleBuilder.toJs(),DrillDownRow:e,UserId:t.manageAccess.getAsList(t.manageAccess.users),ViewOnlyUserId:t.manageAccess.getAsList(t.manageAccess.viewOnlyUsers),DeleteOnlyUserId:t.manageAccess.getAsList(t.manageAccess.deleteOnlyUsers),UserRoles:t.manageAccess.getAsList(t.manageAccess.userRoles),ViewOnlyUserRoles:t.manageAccess.getAsList(t.manageAccess.viewOnlyUserRoles),DeleteOnlyUserRoles:t.manageAccess.getAsList(t.manageAccess.deleteOnlyUserRoles),DataFilters:a.dataFilters,SelectedParameters:t.useStoredProc()?_.map(t.Parameters(),function(e){return{UseDefault:"is default"==e.Operator(),ParameterId:e.Id,ParameterName:e.ParameterName,Value:e.Value(),Operator:e.Operator()}}):[]}},t.SaveFilterAndRunReport=function(){return t.validateReport()?void(t.pager.currentPage(1),ajaxcall({url:a.runReportApiUrl,type:"POST",data:JSON.stringify({method:"/ReportApi/SaveReportFilter",SaveReport:!1,ReportJson:JSON.stringify(t.BuildReportData()),adminMode:t.adminMode(),SubTotalMode:!1})}),t.RunReport(!1)):void toastr.error("Please correct validation issues")},t.RunReport=function(e,r){if(e=!0===e,r=!0===r,t.TotalSeries(t.AdditionalSeries().length),"Single"==t.ReportType()&&1!=t.enabledFields().length)return void toastr.error("All fields except one must be hidden for Single Value Report");if(!r&&!t.validateReport())return void toastr.error("Please correct validation issues");var o=0,l=!1,d=!1,s=null,n=t.AdditionalSeries().length,p=[];do 0<o&&(l=!0,t.CanSaveReports(!1)),p.push(ajaxcall({url:a.runReportApiUrl,type:"POST",data:JSON.stringify({method:"/ReportApi/RunReport",SaveReport:!!t.CanSaveReports()&&t.SaveReport(),ReportJson:JSON.stringify(t.BuildReportData([],l,o-1)),adminMode:t.adminMode(),SubTotalMode:!1}),async:!1}).done(function(r){r.d&&(r=r.d),s=r,t.AllSqlQuries(t.AllSqlQuries()+(r.sql+",")),t.ReportID(r.reportId),t.SaveReport()&&e&&0===n&&(toastr.success("Report Saved"),t.AllSqlQuries(""),t.LoadAllSavedReports(!0)),e||"execute"!=t.ReportMode()&&"dashboard"!=t.ReportMode()||(d=!0,t.ExecuteReportQuery(r.sql,r.connectKey,t.ReportSeries))})),o++;while(o<n+1);$.when.apply($,p).done(function(){if(!1===d){if(e)return;a.samePageOnRun?(a.reportWizard.modal("hide"),t.ReportID(s.reportId),t.ExecuteReportQuery(s.sql,s.connectKey),t.ReportMode("execute")):redirectToReport(a.runReportUrl,{reportId:s.reportId,reportName:t.ReportName(),reportDescription:t.ReportDescription(),includeSubTotal:t.IncludeSubTotal(),showUniqueRecords:t.ShowUniqueRecords(),aggregateReport:t.AggregateReport(),showDataWithGraph:t.ShowDataWithGraph(),reportSql:t.AllSqlQuries(),connectKey:s.connectKey,reportFilter:JSON.stringify(_.map(t.FlyFilters(),function(e){return ko.toJS(e)})),reportType:t.ReportType(),selectedFolder:null==t.SelectedFolder()?0:t.SelectedFolder().Id,reportSeries:_.map(t.AdditionalSeries(),function(r){return r.Value()})})}})},t.ExecuteReportQuery=function(e,r,o){return e&&r?ajaxcall({url:a.execReportUrl,type:"POST",data:JSON.stringify({reportSql:e,connectKey:r,reportType:t.ReportType(),pageNumber:t.pager.currentPage(),pageSize:t.pager.pageSize(),sortBy:t.pager.sortColumn()||"",desc:t.pager.sortDescending()||!1,ReportSeries:o})}).done(function(l){function d(e,r){return!(e!=r)||!(0>r.indexOf("(Count)")&&0>r.indexOf("(Avg)")&&0>r.indexOf("(Sum)")&&0>r.indexOf("(Average)"))&&(r=(r||"").replace("(Count)","").replace("(Avg)","").replace("(Average)","").replace("(Sum)","").trim(),e=(e||"").trim(),e=(e.endsWith("Id")||e.endsWith("ID")?e.slice(0,-2):e).trim(),e==r)}function s(e){t.columnDetails([]),_.forEach(e,function(r){var e;t.useStoredProc()?(e=_.find(t.SelectedFields(),function(e){return d(e.procColumnName,r.ColumnName)}),r.hideStoredProcColumn=!e||e.disabled()):e=_.find(t.SelectedFields(),function(e){return d(e.fieldName,r.ColumnName)}),e&&e.linkField()?(r.linkItem=e.linkFieldItem.toJs(),r.linkField=!0):(r.linkItem={},r.linkField=!1),e=ko.toJS(e||{fieldName:r.ColumnName}),t.columnDetails.push(e),r.decimalPlaces=e.decimalPlaces,r.fieldAlign=e.fieldAlign,r.fieldConditionOp=e.fieldConditionOp,r.fieldConditionVal=e.fieldConditionVal,r.fieldFormat=e.fieldFormat,r.fieldLabel=e.fieldLabel,r.fieldName=e.fieldName,r.fieldWidth=e.fieldWidth,r.fontBold=e.fontBold,r.headerFontBold=e.headerFontBold,r.headerFontColor=e.headerFontColor,r.headerBackColor=e.headerBackColor,r.fieldId=e.fieldId,r.fontColor=e.fontColor,r.backColor=e.backColor,r.groupInGraph=e.groupInGraph,r.dontSubTotal=e.dontSubTotal})}function i(e,o){_.forEach(e,function(e,r){e.LinkTo="";var l=o[r];if(l&&l.linkField){var d=l.linkItem,s="";d.LinksToReport?(s=a.runLinkReportUrl+"?reportId="+d.LinkedToReportId,d.SendAsFilterParameter&&(s+="&filterId="+d.SelectedFilterId+"&filterValue="+e.Value)):s=d.LinkToUrl+(d.SendAsQueryParameter?"?"+d.QueryParameterName+"="+e.LabelValue:""),e.LinkTo=s}if(l=l||{},e.backColor=l.backColor,e.fieldAlign=l.fieldAlign,e.fieldWidth=l.fieldWidth,e.fontBold=l.fontBold,e.fontColor=l.fontColor,e.fieldId=l.fieldId,0<=t.decimalFormatTypes.indexOf(l.fieldFormat))switch(e.FormattedValue=t.formatNumber(e.Value,l.decimalPlaces),l.fieldFormat){case"Currency":e.FormattedValue="$"+e.FormattedValue;break;case"Percentage":e.FormattedValue+="%";}if(0<=t.dateFormatTypes.indexOf(l.fieldFormat))switch(l.fieldFormat){case"Date":e.FormattedValue=new Date(e.Value).toLocaleDateString("en-US",{year:"numeric",month:"numeric",day:"numeric"});break;case"Date and Time":e.FormattedValue=new Date(e.Value).toLocaleDateString("en-US",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"});break;case"Time":e.FormattedValue=new Date(e.Value).toLocaleTimeString("en-US",{hour:"numeric",minute:"numeric",second:"numeric"});}})}l.d&&(l=l.d);var n=t.ReportResult();n.HasError(l.HasError),n.Exception(l.Exception),n.Warnings(l.Warnings),n.ReportDebug(l.ReportDebug),n.ReportSql(l.ReportSql),t.ReportSeries=o,s(l.ReportData.Columns),t.useStoredProc()&&(l.ReportData.Columns=_.filter(l.ReportData.Columns,function(e){return!1==e.hideStoredProcColumn}));var p=_.map(l.ReportData.Columns,"SqlField");l.ReportData.IsDrillDown=ko.observable(!1),_.forEach(l.ReportData.Rows,function(r){r.DrillDownData=ko.observable(null),r.pager=new pagerViewModel({pageSize:10}),r.sql="",r.connectKey="",r.changeSort=function(e){return r.pager.changeSort(e),r.execute(),!1},r.isExpanded=ko.observable(!1),r.execute=function(){""==r.sql||ajaxcall({url:a.execReportUrl,type:"POST",data:JSON.stringify({reportSql:r.sql,connectKey:r.connectKey,reportType:"List",pageNumber:r.pager.currentPage(),pageSize:r.pager.pageSize(),sortBy:r.pager.sortColumn()||"",desc:r.pager.sortDescending()||!1,ReportSeries:o})}).done(function(e){e.d&&(e=e.d),e.ReportData.IsDrillDown=ko.observable(!0),s(e.ReportData.Columns),_.forEach(e.ReportData.Rows,function(r){i(r.Items,e.ReportData.Columns)}),r.DrillDownData(e.ReportData),r.pager.totalRecords(e.Pager.TotalRecords),r.pager.pages(e.Pager.TotalPages)})},r.expand=function(e){// load drill down data
ajaxcall({url:a.runReportApiUrl,type:"POST",data:JSON.stringify({method:"/ReportApi/RunDrillDownReport",SaveReport:!1,ReportJson:JSON.stringify(t.BuildReportData(r.Items)),adminMode:t.adminMode(),SubTotalMode:!1})}).done(function(a){a.d&&(a=a.d),r.sql=a.sql,r.connectKey=a.connectKey,t.expandSqls.push({index:e,sql:r.sql}),r.execute()}),r.isExpanded(!0)},r.pager.currentPage.subscribe(function(){r.execute()}),r.collapse=function(){r.isExpanded(!1)},r.toggle=function(){r.isExpanded()?r.collapse():r.expand()},t.useStoredProc()&&(r.Items=_.filter(r.Items,function(e){return _.includes(p,e.Column.SqlField)})),i(r.Items,l.ReportData.Columns)}),n.ReportData(l.ReportData),t.pager.totalRecords(l.Pager.TotalRecords),t.pager.pages(l.Pager.TotalPages),t.currentSql(e),t.currentConnectKey(r),l.Warnings&&toastr.info("Note: "+l.Warnings),t.isChart()&&(google.charts.load("current",{packages:["corechart","geochart"]}),google.charts.setOnLoadCallback(t.DrawChart)),t.IncludeSubTotal()&&ajaxcall({url:a.runReportApiUrl,type:"POST",data:JSON.stringify({method:"/ReportApi/RunReport",SaveReport:!!t.CanSaveReports()&&t.SaveReport(),ReportJson:JSON.stringify(t.BuildReportData()),adminMode:t.adminMode(),SubTotalMode:!0})}).done(function(e){e.d&&(e=e.d),ajaxcall({url:a.execReportUrl,type:"POST",data:JSON.stringify({reportSql:e.sql,connectKey:e.connectKey,reportType:t.ReportType(),pageNumber:1,pageSize:1,sortBy:"",desc:!1,ReportSeries:null})}).done(function(e){e.d&&(e=e.d),s(e.ReportData.Columns),_.forEach(e.ReportData.Rows,function(r){i(r.Items,e.ReportData.Columns)}),t.ReportResult().SubTotals(e.ReportData.Rows)})}),setTimeout(function(){t.allowTableResize()},2e3)}):void 0},t.expandSqls=ko.observableArray([]),t.ExpandAll=function(){t.expandSqls([]);var r=0;_.forEach(t.ReportResult().ReportData().Rows,function(a){a.expand(r++)}),t.allExpanded(!0)},t.CollapseAll=function(){_.forEach(t.ReportResult().ReportData().Rows,function(r){r.collapse()}),t.allExpanded(!1),t.expandSqls([])},t.getExpandSqls=ko.computed(function(){return t.allExpanded()&&0!=t.expandSqls().length?_.map(_.orderBy(t.expandSqls(),"index"),function(e){return e.sql}):[]}),t.getColumnDetails=ko.computed(function(){var e=JSON.stringify(t.columnDetails());return e}),t.skipDraw=!(!0!==a.skipDraw),t.DrawChart=function(){if(t.isChart()&&!0!==t.skipDraw){// Create the data table.
var e=t.ReportResult().ReportData(),a=new google.visualization.DataTable,o=[],l=[];_.forEach(e.Columns,function(r,e){t.SelectedFields()[e];0==e?a.addColumn(r.IsNumeric?"number":"string",r.fieldLabel||r.ColumnName):r.IsNumeric&&!r.groupInGraph&&l.push({index:e,column:r.fieldLabel||r.ColumnName})}),0==o.length&&_.forEach(e.Columns,function(r,e){0<e&&r.IsNumeric&&!r.groupInGraph&&a.addColumn(r.IsNumeric?"number":"string",r.fieldLabel||r.ColumnName)});var d=[],s=[];_.forEach(e.Rows,function(r){var t=[];_.forEach(r.Items,function(i,r){var n=e.Columns[r];if(0==r)0<o.length?(t=_.filter(d,function(e){return e[0]==i.Value}),0<t.length?(d=d.filter(function(e){return e[0]!=i.Value}),t=t[0]):t.push((i.Column.IsNumeric?parseInt(i.Value):i.Value)||(i.Column.IsNumeric?0:""))):t.push((i.Column.IsNumeric?parseInt(i.Value):i.Value)||(i.Column.IsNumeric?0:""));else if(0<o.length){var p=_.filter(o,function(e){return e.index==r});1==p.length?0==_.filter(s,function(e){return e==i.Value}).length&&(s.push(i.Value||""),_.forEach(l,function(e){a.addColumn("number",i.Value+(0==e?"":"-"+e))})):i.Column.IsNumeric&&t.push((i.Column.IsNumeric?parseInt(i.Value):i.Value)||(i.Column.IsNumeric?0:""))}else i.Column.IsNumeric&&!n.groupInGraph&&t.push((i.Column.IsNumeric?parseInt(i.Value):i.Value)||(i.Column.IsNumeric?0:""))}),d.push(t)}),_.forEach(d,function(e){if(e.length!=a.getNumberOfColumns())for(var r=0;r<=a.getNumberOfColumns()-e.length;r++)e.push(0)}),a.addRows(d);// Set chart options
var i={title:t.ReportName(),animation:{startup:!0,duration:1e3,easing:"out"}},n=document.getElementById("chart_div_"+t.ReportID()),p=null;"Pie"==t.ReportType()&&(p=new google.visualization.PieChart(n)),"Bar"==t.ReportType()&&(p=new google.visualization.ColumnChart(n)),"Line"==t.ReportType()&&(p=new google.visualization.LineChart(n)),"Map"==t.ReportType()&&(p=new google.visualization.GeoChart(n)),p.draw(a,i),t.ChartData(p.getImageURI())}},t.loadFolders=function(e){// Load folders
return ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/GetFolders",model:JSON.stringify({adminMode:t.adminMode()})}}).done(function(r){if(r.d&&(r=r.d),t.Folders(r),t.SelectedFolder(null),e){var a=_.filter(r,function(r){return r.Id==e});0<a.length&&t.SelectedFolder(a[0])}})},t.editLinkField=ko.observable(),t.editFieldOptions=ko.observable(),t.setupField=function(r){r.selectedFieldName=r.tableName+" > "+r.fieldName,r.fieldAggregateWithDrilldown=r.fieldAggregate.concat("Only in Detail").concat("Group in Detail"),r.selectedAggregate=ko.observable(r.aggregateFunction),r.filterOnFly=ko.observable(r.filterOnFly),r.disabled=ko.observable(r.disabled),r.groupInGraph=ko.observable(r.groupInGraph),r.dontSubTotal=ko.observable(r.dontSubTotal),r.hideInDetail=ko.observable(r.hideInDetail),r.linkField=ko.observable(r.linkField),r.linkFieldItem=new linkFieldViewModel(r.linkFieldItem,a),r.isFormulaField=ko.observable(r.isFormulaField),r.fieldFormat=ko.observable(r.fieldFormat),r.fieldLabel=ko.observable(r.fieldLabel),r.decimalPlaces=ko.observable(r.decimalPlaces),r.fieldAlign=ko.observable(r.fieldAlign),r.fontColor=ko.observable(r.fontColor),r.backColor=ko.observable(r.backColor||"#ffffff"),r.headerFontColor=ko.observable(r.headerFontColor),r.headerBackColor=ko.observable(r.headerBackColor||"#ffffff"),r.fontBold=ko.observable(r.fontBold),r.headerFontBold=ko.observable(r.headerFontBold),r.fieldWidth=ko.observable(r.fieldWidth),r.fieldConditionOp=ko.observable(r.fieldConditionOp),r.fieldConditionVal=ko.observable(r.fieldConditionVal),r.applyAllHeaderFontColor=ko.observable(!1),r.applyAllHeaderBackColor=ko.observable(!1),r.applyAllFontColor=ko.observable(!1),r.applyAllBackColor=ko.observable(!1),r.applyAllBold=ko.observable(!1),r.applyAllHeaderBold=ko.observable(!1),r.toggleDisable=function(){!r.disabled()&&2>t.enabledFields().length||r.disabled(!r.disabled())};var o=[];return _.forEach(r.formulaItems||[],function(r){o.push(new formulaFieldViewModel({fieldId:r.fieldId||0,isParenthesesStart:r.setupFormula?r.setupFormula.isParenthesesStart():r.isParenthesesStart,isParenthesesEnd:r.setupFormula?r.setupFormula.isParenthesesEnd():r.isParenthesesEnd,formulaOperation:r.setupFormula?r.setupFormula.formulaOperation():r.formulaOperation,constantValue:r.setupFormula?r.setupFormula.constantValue():r.constantValue}))}),r.formulaItems=ko.observableArray(o),r.setupFormula=new formulaFieldViewModel,r.setupLinkField=function(){t.editLinkField(r),a.linkModal&&a.linkModal.modal("show")},r.removeLinkField=function(){r.linkField(!1),r.linkFieldItem.clear(),a.linkModal&&a.linkModal.modal("hide")},r.saveLinkField=function(){return r.linkFieldItem.validateLink()?void(r.linkField(!0),a.linkModal&&a.linkModal.modal("hide")):void toastr.error("Please correct validation issues")},r.setupFieldOptions=function(){t.currentFieldOptions={fieldFormat:r.fieldFormat(),fieldLabel:r.fieldLabel(),decimalPlaces:r.decimalPlaces(),fieldAlign:r.fieldAlign(),fontColor:r.fontColor(),backColor:r.backColor(),headerFontColor:r.headerFontColor(),headerBackColor:r.headerBackColor(),fontBold:r.fontBold(),headerFontBold:r.headerFontBold(),fieldWidth:r.fieldWidth(),fieldConditionOp:r.fieldConditionOp(),fieldConditionVal:r.fieldConditionVal()},t.editFieldOptions(r),a.fieldOptionsModal&&a.fieldOptionsModal.modal("show")},r.saveFieldOptions=function(){_.forEach(t.SelectedFields(),function(e){r.applyAllHeaderFontColor()&&e.headerFontColor(r.headerFontColor()),r.applyAllHeaderBackColor()&&e.headerBackColor(r.headerBackColor()),r.applyAllFontColor()&&e.fontColor(r.fontColor()),r.applyAllBackColor()&&e.backColor(r.backColor()),r.applyAllBold()&&e.fontBold(r.fontBold()),r.applyAllHeaderBold()&&e.headerFontBold(r.headerFontBold())}),a.fieldOptionsModal&&a.fieldOptionsModal.modal("hide")},r.cancelFieldOptions=function(){r.fieldFormat(t.currentFieldOptions.fieldFormat),r.fieldLabel(t.currentFieldOptions.fieldLabel),r.fieldAlign(t.currentFieldOptions.fieldAlign),r.decimalPlaces(t.currentFieldOptions.decimalPlaces),r.fontColor(t.currentFieldOptions.fontColor),r.backColor(t.currentFieldOptions.backColor),r.headerFontColor(t.currentFieldOptions.headerFontColor),r.headerBackColor(t.currentFieldOptions.headerBackColor),r.fontBold(t.currentFieldOptions.fontBold),r.headerFontBold(t.currentFieldOptions.headerFontBold),r.fieldWidth(t.currentFieldOptions.fieldWidth),r.fieldConditionOp(t.currentFieldOptions.fieldConditionOp),r.fieldConditionVal(t.currentFieldOptions.fieldConditionVal),a.fieldOptionsModal&&a.fieldOptionsModal.modal("hide")},r},t.PopulateReport=function(e,r,o){function l(e,r){e&&0!=e.length&&_.forEach(e,function(a){if(!a.FieldId)r=null==r?t.FilterGroups()[0]:r.AddFilterGroup({AndOr:a.AndOr});else if(0>s.indexOf(a.FieldId)){var e=0<_.filter(t.SelectedFields(),function(e){return!0==e.filterOnFly()&&e.fieldId==a.FieldId}).length;e&&s.push({fieldId:a.FieldId}),null==r&&(r=t.FilterGroups()[0]),r.AddFilter(a,e)}l(a.Filters,r)})}t.ReportID(e.ReportID),t.ReportType(e.ReportType),t.ReportName(e.ReportName),t.ReportDescription(e.ReportDescription),t.FolderID(e.FolderID),t.ChosenFields([]),t.SelectFields([]),t.SelectedField(null),t.manageAccess.setupList(t.manageAccess.users,e.UserId||""),t.manageAccess.setupList(t.manageAccess.userRoles,e.UserRoles||""),t.manageAccess.setupList(t.manageAccess.viewOnlyUserRoles,e.ViewOnlyUserRoles||""),t.manageAccess.setupList(t.manageAccess.viewOnlyUsers,e.ViewOnlyUserId||""),t.manageAccess.setupList(t.manageAccess.deleteOnlyUserRoles,e.DeleteOnlyUserRoles||""),t.manageAccess.setupList(t.manageAccess.deleteOnlyUsers,e.DeleteOnlyUserId||""),t.IncludeSubTotal(e.IncludeSubTotals),t.EditFiltersOnReport(e.EditFiltersOnReport),t.ShowUniqueRecords(e.ShowUniqueRecords),t.AggregateReport(e.IsAggregateReport),t.ShowDataWithGraph(e.ShowDataWithGraph),t.ShowOnDashboard(e.ShowOnDashboard),t.SortByField(e.SortBy),t.SortDesc(e.SortDesc),t.pager.sortDescending(e.SortDesc);var d=_.find(t.SavedReports(),{reportId:e.ReportID})||{canEdit:!1};t.CanEdit(d.canEdit||t.adminMode()),t.FilterGroups([]),t.AdditionalSeries([]),t.SortFields([]),t.scheduleBuilder.fromJs(e.Schedule),t.HideReportHeader(e.HideReportHeader),t.useReportHeader(e.UseReportHeader&&!e.HideReportHeader),"execute"==t.ReportMode()&&(t.useReportHeader()?(t.headerDesigner.init(!0),t.headerDesigner.loadCanvas(!0)):t.headerDesigner.dispose());var s=[];if(!0==r){if(a.reportFilter&&"[]"!=a.reportFilter){// get fields on the fly submitted by user before
var i=JSON.parse(a.reportFilter);_.forEach(i,function(r){var e=_.filter(s,function(e){return e.fieldId==r.Field.fieldId});0<e.length&&(r.FieldId=r.Field.fieldId,r.Value1=r.Value,s.push(e[0]),t.FilterGroups()[0].AddFilter(r,!0))})}l(e.Filters)}else l(e.Filters);return(_.forEach(e.Series,function(r){t.AddSeries(r)}),_.forEach(e.SelectedSorts,function(r){t.addSortField(r.FieldId,r.Descending)}),t.SaveReport(!r&&t.CanEdit()),!o&&0<t.AdditionalSeries().length&&(o=_.map(t.AdditionalSeries(),function(r){return r.Value()}).join(",")),"execute"==t.ReportMode()||"dashboard"==t.ReportMode())?t.ExecuteReportQuery(a.reportSql,a.reportConnect,o):void 0},t.LoadReport=function(e,r,o){return t.SelectedTable(null),t.isFormulaField(!1),ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/LoadReport",model:JSON.stringify({reportId:e,adminMode:t.adminMode(),userIdForSchedule:t.userIdForSchedule})}}).done(function(e){if(e.d&&(e=e.d),t.useStoredProc(e.UseStoredProc),t.ReportType(e.ReportType),t.useStoredProc()){function a(){var a=_.find(t.Procs(),{Id:e.StoredProcId});if(a)return a.SelectedFields=e.SelectedFields,a.SelectedParameters=e.SelectedParameters,t.SelectedProc(a),t.PopulateReport(e,r,o)}0==t.Procs().length?t.loadProcs().done(function(){a()}):a()}else return _.forEach(e.SelectedFields,function(r){r=t.setupField(r)}),t.SelectedFields(e.SelectedFields),t.PopulateReport(e,r,o)})},t.LoadAllSavedReports=function(r){ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/GetSavedReports",model:JSON.stringify({adminMode:t.adminMode()})}}).done(function(e){e.d&&(e=e.d),_.forEach(e,function(o){o.runMode=!1,o.openReport=function(){// Load report
return t.LoadReport(o.reportId).done(function(){o.runMode?(t.SaveReport(!1),t.RunReport(!1,!0),o.runMode=!1):t.ReportMode("generate")})},o.copyReport=function(){o.openReport().done(function(){t.ReportID(0),t.ReportName("Copy of "+t.ReportName()),t.CanEdit(!0),t.SaveReport(!0)})},o.runReport=function(){o.runMode=!0,o.openReport()},o.deleteReport=function(){bootbox.confirm("Are you sure you would like to Delete this Report?",function(e){e&&ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/DeleteReport",model:JSON.stringify({reportId:o.reportId})}}).done(function(){t.SavedReports.remove(o)})})},0<a.reportId&&o.reportId==a.reportId&&!0!==r&&(o.openReport(),a.reportWizard.modal("show"))}),t.SavedReports(e)})},"dashboard"!=t.ReportMode()&&t.loadFolders().done(function(){t.LoadAllSavedReports(),ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/CanSaveReports",model:"{}"}}).done(function(e){e.d&&(e=e.d),e=e||{allowUsersToCreateReports:!0,allowUsersToManageFolders:!0},t.CanSaveReports(e.allowUsersToCreateReports),t.CanManageFolders(e.allowUsersToManageFolders)})}),t.changeSort=function(e){return t.pager.changeSort(e),t.ExecuteReportQuery(t.currentSql(),t.currentConnectKey(),t.ReportSeries),!1},t.formatNumber=function(e,r){var a=Math.abs;return null===r&&(r=2),r=isNaN(r=a(r))?2:r,parseFloat(e).toFixed(r).replace(/\B(?=(\d{3})+(?!\d))/g,",")},t.isInputValid=function(e){// first check for custom validation
return(null==$(e).attr("data-notempty")||0!=$(e).children("option").length)&&(e.validity?e.validity.valid:null==$(e).attr("required")||""!=$(e).val());// next try html5 validation if availble
// finally just check for required attr
},t.validateReport=function(){if(null!=a.reportWizard){var e=a.reportWizard.find("input,select"),r=!0;$(".needs-validation").removeClass("was-validated");for(var o=0;o<e.length;o++)$(e[o]).removeClass("is-invalid"),t.isInputValid(e[o])||(r=!1,$(".needs-validation").addClass("was-validated"),$(e[o]).addClass("is-invalid"));return _.forEach(t.SavedReports(),function(a){if(a.reportName==t.ReportName()&&a.reportId!=t.ReportID())return r=!1,toastr.error("Report name is already in use, please choose a different name"),!1}),r}},t.loadProcs=function(){return ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/GetProcedures",model:JSON.stringify({adminMode:t.adminMode()})}}).done(function(e){e.d&&(e=e.d),t.Procs(e)})},t.loadTables=function(){// Load tables
ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/GetTables",model:JSON.stringify({adminMode:t.adminMode()})}}).done(function(e){e.d&&(e=e.d),t.Tables(e)})},t.init=function(e,r){if(r)return void $("#noaccountModal").modal("show");t.loadFolders(e),t.loadTables(),t.loadProcs();var a=!1;localStorage&&(a=localStorage.getItem("reportAdminMode")),"true"===a&&t.adminMode(!0)},t.allowTableResize=function(){var r,o;Array.prototype.forEach.call(document.querySelectorAll(".report-inner table th"),function(a){a.style.position="relative";var e=document.createElement("div");e.innerHTML="&nbsp;",e.style.top=0,e.style.right=0,e.style.bottom=0,e.style.width="5px",e.style.position="absolute",e.style.cursor="col-resize",e.addEventListener("mousedown",function(t){r=a,o=a.offsetWidth-t.pageX}),a.appendChild(e)}),document.addEventListener("mousemove",function(a){r&&(r.style.width=o+a.pageX+"px")}),document.addEventListener("mouseup",function(){if(r&&r.id&&r.style){var e=_.find(t.SelectedFields(),{fieldId:parseInt(r.id)});e&&e.fieldWidth(r.style.width),ajaxcall({url:a.apiUrl,noBlocking:!0,data:{method:"/ReportApi/UpdateReportColumnWidth",model:JSON.stringify({width:r.style.width,fieldId:parseInt(r.id),reportId:parseInt(t.ReportID())})}})}r=void 0})}},dashboardViewModel=function(e){var a=this;e.isDashboard=!0,a.dashboards=ko.observableArray(e.dashboards||[]),a.adminMode=ko.observable(!1),a.currentUserId=e.userId,a.currentUserRole=(e.currentUserRole||[]).join(),a.reportsAndFolders=ko.observableArray([]),a.allowAdmin=ko.observable(e.allowAdmin);var t=0<e.dashboardId?_.find(a.dashboards(),{id:e.dashboardId})||{name:"",description:""}:0<a.dashboards().length?a.dashboards()[0]:{name:"",description:""};a.dashboard={Id:ko.observable(t.id),Name:ko.observable(t.name),Description:ko.observable(t.description),manageAccess:manageAccess(e)},a.currentDashboard=ko.observable(t),a.selectDashboard=ko.observable(t.id),a.selectDashboard.subscribe(function(e){e!=a.currentDashboard().id&&(window.location=window.location.href.split("?")[0]+"?id="+e)}),a.newDashboard=function(){a.dashboard.Id(0),a.dashboard.Name(""),a.dashboard.Description(""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.users,""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.userRoles,""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.viewOnlyUserRoles,""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.viewOnlyUsers,""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.deleteOnlyUserRoles,""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.deleteOnlyUsers,""),_.forEach(a.reportsAndFolders(),function(e){_.forEach(e.reports,function(e){e.selected(!1)})})},a.editDashboard=function(){a.dashboard.Id(a.currentDashboard().id),a.dashboard.Name(a.currentDashboard().name),a.dashboard.Description(a.currentDashboard().description),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.users,a.currentDashboard().userId||""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.userRoles,a.currentDashboard().userRoles||""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.viewOnlyUserRoles,a.currentDashboard().viewOnlyUserRoles||""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.viewOnlyUsers,a.currentDashboard().viewOnlyUserId||""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.deleteOnlyUserRoles,a.currentDashboard().deleteOnlyUserRoles||""),a.dashboard.manageAccess.setupList(a.dashboard.manageAccess.deleteOnlyUsers,a.currentDashboard().deleteOnlyUserId||"");var e=(a.currentDashboard().selectedReports||"").split(",");_.forEach(a.reportsAndFolders(),function(r){_.forEach(r.reports,function(a){a.selected(0<=e.indexOf(a.reportId.toString()))})})},a.saveDashboard=function(){if($(".form-group").removeClass("needs-validation"),!a.dashboard.Name())return $("#add-dash-name").closest(".form-group").addClass("needs-validation"),!1;var t="";_.forEach(a.reportsAndFolders(),function(e){_.forEach(e.reports,function(e){e.selected()&&(t+=(t?",":"")+e.reportId)})});var o={id:a.dashboard.Id()||0,name:a.dashboard.Name(),description:a.dashboard.Description(),selectedReports:t,userIdAccess:a.dashboard.manageAccess.getAsList(a.dashboard.manageAccess.users),viewOnlyUserId:a.dashboard.manageAccess.getAsList(a.dashboard.manageAccess.viewOnlyUsers),deleteOnlyUserId:a.dashboard.manageAccess.getAsList(a.dashboard.manageAccess.deleteOnlyUsers),userRolesAccess:a.dashboard.manageAccess.getAsList(a.dashboard.manageAccess.userRoles),viewOnlyUserRoles:a.dashboard.manageAccess.getAsList(a.dashboard.manageAccess.viewOnlyUserRoles),deleteOnlyUserRoles:a.dashboard.manageAccess.getAsList(a.dashboard.manageAccess.deleteOnlyUserRoles),adminMode:a.adminMode()};return ajaxcall({url:e.apiUrl,data:{method:"/ReportApi/SaveDashboard",model:JSON.stringify(o)}}).done(function(e){e.d&&(e=e.d),toastr.success("Dashboard saved successfully"),setTimeout(function(){window.location=window.location.href.split("?")[0]+"?id="+e.id},500)}),!0},a.deleteDashboard=function(){bootbox.confirm("Are you sure you would like to Delete this Dashboard?",function(t){t&&ajaxcall({url:e.apiUrl,data:{method:"/ReportApi/DeleteDashboard",model:JSON.stringify({id:a.currentDashboard().id,adminMode:a.adminMode()})}}).done(function(){toastr.success("Dashboard deleted successfully"),setTimeout(function(){window.location=window.location.href.split("?")[0]},500)})})},a.reports=ko.observableArray([]);var o=0;_.forEach(e.reports,function(r){var t=new reportViewModel({runReportUrl:e.runReportUrl,execReportUrl:e.execReportUrl,reportWizard:e.reportWizard,lookupListUrl:e.lookupListUrl,runReportApiUrl:e.runReportApiUrl,apiUrl:e.apiUrl,reportFilter:r.reportFilter,reportMode:"dashboard",reportSql:r.reportSql,reportId:r.reportId,reportConnect:r.connectKey,users:e.users,userRoles:e.userRoles,skipDraw:!0});t.x=ko.observable(r.x),t.y=ko.observable(r.y),t.width=ko.observable(r.width),t.height=ko.observable(r.height),t.panelStyle="panel-"+(0==o?"default":1==o?"info":2==o?"warning":"danger"),o=3==o?0:o+1,a.reports.push(t),t.LoadReport(r.reportId,!0,""),t.showFlyFilters=ko.observable(!1),t.toggleFlyFilters=function(){t.showFlyFilters(!t.showFlyFilters())}}),a.drawChart=function(){_.forEach(a.reports(),function(e){e.skipDraw=!1,e.DrawChart()})},a.updatePosition=function(r){r&&r.id&&ajaxcall({url:e.apiUrl,noBlocking:!0,data:{method:"/ReportApi/UpdateDashboardReportPosition",model:JSON.stringify({x:r.x,y:r.y,width:r.width,height:r.height,dashboardId:a.currentDashboard().id,reportId:parseInt(r.id)})}})},a.init=function(){var r=!1;localStorage&&(r=localStorage.getItem("reportAdminMode")),"true"===r&&a.adminMode(!0);return $.when(function(){return ajaxcall({url:e.apiUrl,data:{method:"/ReportApi/GetSavedReports",model:JSON.stringify({adminMode:a.adminMode()})}})}(),function(){return ajaxcall({url:e.apiUrl,data:{method:"/ReportApi/GetFolders",model:JSON.stringify({adminMode:a.adminMode()})}})}()).done(function(e,r){var t=[];r[0].d&&(r[0]=r[0].d),e[0].d&&(e[0]=e[0].d),_.forEach(r[0],function(r){var a=_.filter(e[0],{folderId:r.Id});t.push({folderId:r.Id,folder:r.FolderName,reports:_.map(a,function(e){return{reportId:e.reportId,reportName:e.reportName,reportDescription:e.reportDescription,reportType:e.reportType,selected:ko.observable(!1)}})})}),a.reportsAndFolders(t)})},a.adminMode.subscribe(function(e){localStorage&&localStorage.setItem("reportAdminMode",e)})};
function Amar(){alert("amar")}function AppViewModel1(){this.firstName1="fname_ko_1",this.lastName1="lname_ko_1"}function AppViewModel2(){this.firstName2="fname_ko_2",this.lastName2="lname_ko_2"}$(document).ready(function(){console.log("Jquery loaded"),$(".btn").css("border","3px solid red")});function Ko1(){ko.applyBindings(new AppViewModel1)}function Ko2(){ko.applyBindings(new AppViewModel2)}module.exports={Ko1,Ko2,Amar};
