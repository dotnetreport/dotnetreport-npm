var ko=require("knockout"),$=require("jquery");/// .Net Report Builder helper methods
// Ajax call wrapper function
function ajaxcall(a){let b=!0===a.noBlocking,c=window.abp||null;return $.blockUI&&!b&&$.blockUI({baseZ:500}),$.ajax({url:a.url,type:a.type||"GET",data:a.data,cache:a.cache||!1,dataType:a.dataType||"json",contentType:a.contentType||"application/json; charset=utf-8",headers:a.headers||{},async:!1!==a.async||a.async,beforeSend:function(b){if(c){let d=c.auth.getToken();d&&b.setRequestHeader("Authorization","Bearer "+d),"POST"==a.type&&b.setRequestHeader(c.security.antiForgery.tokenHeaderName,c.security.antiForgery.getToken())}}}).done(function(){$.unblockUI&&$.unblockUI(),a=null}).fail(function(b,c,d){$.unblockUI&&$.unblockUI(),a=null,b.responseJSON&&b.responseJSON.d&&(b.responseJSON=b.responseJSON.d);var e=b.responseJSON&&b.responseJSON.Message?"\n"+b.responseJSON.Message:"";"Conflict"==d?toastr.error("Conflict detected. Please ensure the record is not a duplicate and that it has no related records."+e):"Bad Request"==d?toastr.error("Validation failed for your request. Please make sure the data provided is correct."+e):"Unauthorized"==d?toastr.error("You are not authorized to make that request."+e):"Forbidden"==d?location.reload(!0):"Not Found"==d?toastr.error("Record not found."+e):"Internal Server Error"==d?toastr.error("The system was unable to complete your request. <br>Service Reponse: "+e):toastr.error(c+": "+e)})}// knockout binding extenders
ko.bindingHandlers.datepicker={init:function(a,b,c){//initialize datepicker with some optional options
var d=c().datepickerOptions||{};//handle the field changing
//handle disposal (if KO removes by the template binding)
$(a).datepicker(d),ko.utils.registerEventHandler(a,"change",function(){var c=b();c($(a).datepicker({dateFormat:"mm/dd/yyyy"}).val())}),ko.utils.domNodeDisposal.addDisposeCallback(a,function(){$(a).datepicker("destroy")})},//update the control when the view model changes
update:function(a,b){var c=ko.utils.unwrapObservable(b()),d=$(a).datepicker("getDate");0!=c-d&&$(a).datepicker("setDate",c)}},ko.bindingHandlers.fadeVisible={init:function(a,b){// Initially set the element to be instantly visible/hidden depending on the value
var c=b();$(a).toggle(ko.utils.unwrapObservable(c))},update:function(a,b){// Whenever the value subsequently changes, slowly fade the element in or out
var c=b();ko.utils.unwrapObservable(c)?$(a).fadeIn("slow"):$(a).hide()}},ko.bindingHandlers.checkedInArray={init:function(a,b){ko.utils.registerEventHandler(a,"click",function(){var c=ko.utils.unwrapObservable(b()),d=c.array,// don't unwrap array because we want to update the observable array itself
e=ko.utils.unwrapObservable(c.value),f=a.checked;ko.utils.addOrRemoveItem(d,e,f)})},update:function(a,b){var c=ko.utils.unwrapObservable(b()),d=ko.utils.unwrapObservable(c.array),e=ko.utils.unwrapObservable(c.value);a.checked=0<=ko.utils.arrayIndexOf(d,e)}},ko.bindingHandlers.select2={after:["options","value"],init:function(a,b){$(a).select2(ko.unwrap(b())),ko.utils.domNodeDisposal.addDisposeCallback(a,function(){$(a).select2("destroy")})},update:function(a,b,c){var d=c(),e=$(a).data("select2");if("value"in d){var f=""+ko.unwrap(d.value);(d.select2.multiple||a.multiple)&&f.constructor!==Array?e.val([f.split(",")]):e.val([f])}if("selectedOptions"in d&&0==e.val().length){var f=ko.unwrap(d.selectedOptions);(d.select2.multiple||a.multiple)&&f&&f.constructor==Array&&e.val([f])}}};function redirectToReport(a,b,c){b="undefined"==typeof b?{}:b,c="undefined"!=typeof c&&c;var d=document.createElement("form");return $(d).attr("id","reg-form").attr("name","reg-form").attr("action",a).attr("method","post").attr("enctype","multipart/form-data"),c&&$(d).attr("target","_blank"),$.each(b,function(a){$(d).append("<input type=\"text\" name=\""+a+"\" value=\""+escape(this)+"\" />")}),document.body.appendChild(d),d.submit(),document.body.removeChild(d),!1}function htmlDecode(a){var b=document.createElement("div");return b.innerHTML=a,0===b.childNodes.length?"":b.childNodes[0].nodeValue}module.exports={ajaxcall,redirectToReport,htmlDecode};
var manageViewModel=function(a){var b=this;b.keys={AccountApiKey:a.model.AccountApiKey,DatabaseApiKey:a.model.DatabaseApiKey},b.DataConnections=ko.observableArray([]),b.Tables=new tablesViewModel(a),b.Joins=ko.observableArray([]),b.currentConnectionKey=ko.observable(b.keys.DatabaseApiKey),b.canSwitchConnection=ko.computed(function(){return b.currentConnectionKey()!=b.keys.DatabaseApiKey}),b.switchConnection=function(){b.canSwitchConnection()&&bootbox.confirm("Are you sure you would like to switch your Database Connection?",function(a){a&&(window.location.href=window.location.pathname+"?"+$.param({databaseApiKey:b.currentConnectionKey()}))})},b.JoinFilters={primaryTable:ko.observable(),primaryField:ko.observable(),joinType:ko.observable(),joinTable:ko.observable(),joinField:ko.observable()},b.filteredJoins=ko.computed(function(){var a=b.JoinFilters.primaryTable(),c=b.JoinFilters.primaryField(),d=b.JoinFilters.joinType(),e=b.JoinFilters.joinTable(),f=b.JoinFilters.joinField(),g=b.Joins();return _.filter(g,function(b){return(!a||!b.JoinTable()||0<=b.JoinTable().DisplayName().toLowerCase().indexOf(a.toLowerCase()))&&(!c||!b.FieldName()||0<=b.FieldName().toLowerCase().indexOf(c.toLowerCase()))&&(!d||!b.JoinType()||0<=b.JoinType().toLowerCase().indexOf(d.toLowerCase()))&&(!e||!b.OtherTable()||0<=b.OtherTable().DisplayName().toLowerCase().indexOf(e.toLowerCase()))&&(!f||!b.JoinFieldName()||0<=b.JoinFieldName().toLowerCase().indexOf(f.toLowerCase()))})}),b.JoinTypes=["INNER","LEFT","LEFT OUTER","RIGHT","RIGHT OUTER"],b.editColumn=ko.observable(),b.selectColumn=function(a){b.editColumn(a)},b.editAllowedRoles=ko.observable(),b.newAllowedRole=ko.observable(),b.selectAllowedRoles=function(a){b.editAllowedRoles(a)},b.removeAllowedRole=function(a){b.editAllowedRoles().AllowedRoles.remove(a)},b.addAllowedRole=function(){return!b.newAllowedRole()||0<_.filter(b.editAllowedRoles().AllowedRoles(),function(a){return a==b.newAllowedRole()}).length?void toastr.error("Please add a new unique Role"):void(b.editAllowedRoles().AllowedRoles.push(b.newAllowedRole()),b.newAllowedRole(null))},b.newDataConnection={Name:ko.observable(),ConnectionKey:ko.observable(),copySchema:ko.observable(!1),copyFrom:ko.observable()},b.addDataConnection=function(){return($(".form-group").removeClass("has-error"),!b.newDataConnection.Name())?($("#add-conn-name").closest(".form-group").addClass("has-error"),!1):b.newDataConnection.ConnectionKey()?(ajaxcall({url:a.addDataConnectionUrl,type:"POST",data:JSON.stringify({account:b.keys.AccountApiKey,dataConnect:b.newDataConnection.copySchema()?b.newDataConnection.copyFrom():b.keys.DatabaseApiKey,newDataConnect:b.newDataConnection.Name(),connectionKey:b.newDataConnection.ConnectionKey(),copySchema:b.newDataConnection.copySchema()})}).done(function(a){b.DataConnections.push({Id:a.Id,DataConnectName:b.newDataConnection.Name(),ConnectionKey:b.newDataConnection.ConnectionKey(),DataConnectGuid:a.DataConnectGuid}),b.newDataConnection.Name(""),b.newDataConnection.ConnectionKey(""),toastr.success("Data Connection added successfully"),$("#add-connection-modal").modal("hide")}),!0):($("#add-conn-key").closest(".form-group").addClass("has-error"),!1)},b.setupJoin=function(a){return a.JoinTable=ko.observable(),a.OtherTable=ko.observable(),a.originalField=a.FieldName,a.originalJoinField=a.JoinFieldName,a=ko.mapping.fromJS(a),a.OtherTables=ko.computed(function(){return $.map(b.Tables.model(),function(b){return null!=a.JoinTable()&&b.Id()==a.JoinTable().Id()||0>=b.Id()?null:b})}),a.OtherTable.subscribe(function(){a.FieldName(a.originalField()),a.JoinFieldName(a.originalJoinField())}),a.JoinTable.subscribe(function(){a.FieldName(a.originalField()),a.JoinFieldName(a.originalJoinField())}),a.DeleteJoin=function(){bootbox.confirm("Are you sure you would like to delete this Join?",function(c){c&&b.Joins.remove(a)})},a.JoinTable(_.filter(b.Tables.model(),function(b){return b.Id()==a.TableId()})[0]),a.OtherTable(_.filter(a.OtherTables(),function(b){return b.Id()==a.JoinedTableId()})[0]),a},b.LoadDataConnections=function(){ajaxcall({url:a.getDataConnectionsUrl,type:"POST",data:JSON.stringify({account:b.keys.AccountApiKey,dataConnect:b.keys.DatabaseApiKey})}).done(function(a){b.DataConnections(a),b.currentConnectionKey(b.keys.DatabaseApiKey)})},b.LoadJoins=function(){// Load and setup Relations
ajaxcall({url:a.getRelationsUrl,type:"POST",data:JSON.stringify({account:b.keys.AccountApiKey,dataConnect:b.keys.DatabaseApiKey})}).done(function(a){b.Joins($.map(a,function(a){return b.setupJoin(a)}))})},b.AddJoin=function(){b.Joins.push(b.setupJoin({TableId:0,JoinedTableId:0,JoinType:"INNER",FieldName:"",JoinFieldName:""}))},b.getJoinsToSave=function(){$.each(b.Joins(),function(a,b){b.TableId(b.JoinTable().Id()),b.JoinedTableId(b.OtherTable().Id())});var a=$.map(ko.mapping.toJS(b.Joins),function(a){return{DataConnectionId:a.DataConnectionId,RelationId:a.Id,TableId:a.TableId,JoinedTableId:a.JoinedTableId,JoinType:a.JoinType,FieldName:a.FieldName,JoinFieldName:a.JoinFieldName}});return a},b.SaveJoins=function(){var c=b.getJoinsToSave();ajaxcall({url:a.saveRelationsUrl,type:"POST",data:JSON.stringify({account:b.keys.AccountApiKey,dataConnect:b.keys.DatabaseApiKey,relations:c})}).done(function(a){"Success"==a&&toastr.success("Changes saved successfully.")})},b.saveChanges=function(){var a=$.map(b.Tables.model(),function(a){if(a.Selected())return a});return 0==a.length?void toastr.error("Please choose some tables and columns"):void bootbox.confirm("Are you sure you would like to continue with saving your changes?<br><b>Note: </b>This will make changes to your account that cannot be undone.",function(c){c&&$.each(a,function(a,c){c.saveTable(b.keys.AccountApiKey,b.keys.DatabaseApiKey)})})},b.download=function(b,c,d){var e=document.createElement("a"),a=new Blob([b],{type:d});e.href=URL.createObjectURL(a),e.download=c,e.click()},b.exportAll=function(){var a=$.map(b.Tables.model(),function(a){if(a.Selected())return ko.mapping.toJS(a,{ignore:["saveTable","JoinTable"]})}),c=b.getJoinsToSave(),d=JSON.stringify({tables:a,joins:c}),e=_.filter(b.DataConnections(),function(a,c){return c.DataConnectGuid==b.currentConnectionKey()});b.download(d,(0<e.length?e[0].DataConnectName:"dotnet-dataconnection-export")+".json","text/plain")},b.importingFile=ko.observable(!1),b.importCancel=function(){b.importingFile(!1)},b.importFile=function(a){var c=new FileReader;c.onload=function(a){var c=JSON.parse(a.target.result);$.each(c.tables,function(a,c){var d=_.filter(b.Tables.model(),function(a){return a.TableName().toLowerCase()==c.TableName.toLowerCase()});if(0<d.length)d[0];else;}),$("#import-file").val("")},c.readAsText(a),b.importingFile(!1)},b.importStart=function(){b.importingFile(!0)}},tablesViewModel=function(a){var b=this;b.model=ko.mapping.fromJS(a.model.Tables),$.each(b.model(),function(c,d){d.availableColumns=ko.computed(function(){return _.filter(d.Columns(),function(a){return 0<a.Id()&&a.Selected()})}),$.each(d.Columns(),function(a,c){var d=_.filter(b.model(),function(a){return a.TableName()==c.ForeignTable()});c.JoinTable=ko.observable(null!=d&&0<d.length?d[0]:null),c.JoinTable.subscribe(function(a){c.ForeignTable(a.TableName())})}),d.saveTable=function(b,c){var f=ko.mapping.toJS(d,{ignore:["saveTable","JoinTable"]});return d.Selected()?0==_.filter(f.Columns,function(a){return a.Selected}).length?void toastr.error("Cannot save table "+f.DisplayName+", no columns selected"):void ajaxcall({url:a.saveTableUrl,type:"POST",data:JSON.stringify({account:b,dataConnect:c,table:f})}).done(function(){toastr.success("Saved table "+f.DisplayName)}):void bootbox.confirm("Are you sure you would like to delete Table '"+f.DisplayName+"'?",function(d){d&&ajaxcall({url:a.deleteTableUrl,type:"POST",data:JSON.stringify({account:b,dataConnect:c,tableId:f.Id})}).done(function(){toastr.success("Deleted table "+f.DisplayName)})})}}),b.availableTables=ko.computed(function(){return _.filter(b.model(),function(a){return 0<a.Id()&&a.Selected()})}),b.tableFilter=ko.observable(),b.filteredTables=ko.computed(function(){var a=b.tableFilter();return null==a||""==a?b.model():_.filter(b.model(),function(b){return 0<=b.TableName().toLowerCase().indexOf(a.toLowerCase())})}),b.clearTableFilter=function(){b.tableFilter("")},b.selectAll=function(){$.each(b.model(),function(a,b){b.Selected()||(b.Selected(!0),$.each(b.Columns(),function(a,b){b.Selected(!0)}))})},b.unselectAll=function(){$.each(b.model(),function(a,b){b.Selected(!1),$.each(b.Columns(),function(a,b){b.Selected(!1)})})},b.selectAllColumns=function(a){$.each(a.Columns(),function(a,b){b.Selected(!0)})},b.unselectAllColumns=function(a){$.each(a.Columns(),function(a,b){b.Selected(!1)})},b.columnSorted=function(a){$.each(a.targetParent(),function(a,b){b.DisplayOrder(a)})}};module.exports={manageViewModel,tablesViewModel};
/// .Net Report Builder view model v3.0.1
/// License has to be purchased for use
/// 2015-2018 (c) www.dotnetreport.com
function pagerViewModel(a){a=a||{};var b=this;b.pageSize=ko.observable(a.pageSize||30),b.pages=ko.observable(a.pages||1),b.currentPage=ko.observable(a.currentPage||1),b.pauseNavigation=ko.observable(!1),b.totalRecords=ko.observable(0),b.sortColumn=ko.observable(),b.sortDescending=ko.observable(),b.isFirstPage=ko.computed(function(){var a=this;return 1==a.currentPage()},b),b.isLastPage=ko.computed(function(){var a=this;return a.currentPage()==a.pages()},b),b.currentPage.subscribe(function(a){a>b.pages()&&b.currentPage(0==b.pages()?1:b.pages()),1>a&&b.currentPage(1)}),b.previous=function(){b.pauseNavigation()||b.isFirstPage()||isNaN(b.currentPage())||b.currentPage(+b.currentPage()-1)},b.next=function(){b.pauseNavigation()||b.isLastPage()||isNaN(b.currentPage())||b.currentPage(+b.currentPage()+1)},b.first=function(){b.pauseNavigation()||b.currentPage(1)},b.last=function(){b.pauseNavigation()||b.currentPage(b.pages())},b.changeSort=function(a){b.sortColumn()==a?b.sortDescending(!b.sortDescending()):b.sortDescending(!1),b.sortColumn(a),1!=b.currentPage()&&b.currentPage(1)}}function formulaFieldViewModel(a){a=a||{};var b=this;b.fieldId=ko.observable(a.fieldId),b.isParenthesesStart=ko.observable(a.isParenthesesStart),b.isParenthesesEnd=ko.observable(a.isParenthesesEnd),b.formulaOperation=ko.observable(a.formulaOperation),b.isConstantValue=ko.observable(!!a.constantValue),b.constantValue=ko.observable(a.constantValue)}function scheduleBuilder(){var a=this;a.options=["day","week","month","year"],a.showAtTime=ko.observable(!0),a.showDays=ko.observable(!1),a.showMonths=ko.observable(!1),a.showDates=ko.observable(!1),a.selectedOption=ko.observable("day"),a.selectedDays=ko.observableArray([]),a.selectedMonths=ko.observableArray([]),a.selectedDates=ko.observableArray([]),a.selectedHour=ko.observable("12"),a.selectedMinute=ko.observable("00"),a.selectedAmPm=ko.observable("PM"),a.days=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],a.months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],a.dates=[],a.hours=[],a.minutes=["00","15","30","45"];for(var b=1;31>=b;b++)a.dates.push(b);for(var b=1;12>=b;b++)a.hours.push(b);a.hasSchedule=ko.observable(!1),a.emailTo=ko.observable(""),a.selectedOption.subscribe(function(b){a.selectedDays([]),a.selectedMonths([]),a.selectedDates([]);"day"===b?(a.showDays(!1),a.showDates(!1),a.showMonths(!1)):"week"===b?(a.showDays(!0),a.showDates(!1),a.showMonths(!1)):"month"===b?(a.showDays(!1),a.showDates(!0),a.showMonths(!1)):"year"===b?(a.showDays(!1),a.showDates(!0),a.showMonths(!0)):void 0}),a.toJs=function(){return a.hasSchedule()?{SelectedOption:a.selectedOption(),SelectedDays:a.selectedDays().join(","),SelectedMonths:a.selectedMonths().join(","),SelectedDates:a.selectedDates().join(","),SelectedHour:a.selectedHour(),SelectedMinute:a.selectedMinute(),SelectedAmPm:a.selectedAmPm(),EmailTo:a.emailTo()}:null},a.fromJs=function(b){a.hasSchedule(!!b),b=b||{SelectedOption:"day",SelectedDays:"",SelectedMonths:"",SelectedDates:""},a.selectedOption(b.SelectedOption),a.selectedDays(_.map(b.SelectedDays.split(","),function(a){return parseInt(a)})),a.selectedMonths(_.map(b.SelectedMonths.split(","),function(a){return parseInt(a)})),a.selectedDates(_.map(b.SelectedDates.split(","),function(a){return parseInt(a)})),a.selectedHour(b.SelectedHour||"12"),a.selectedMinute(b.SelectedMinute||"00"),a.selectedAmPm(b.SelectedAmPm||"PM"),a.emailTo(b.EmailTo||"")},a.clear=function(){a.fromJs(null)}}function filterGroupViewModel(a){a=a||{};var b=this;b.isRoot=!(!0!==a.isRoot),b.AndOr=ko.observable(a.AndOr||" AND "),b.Filters=ko.observableArray([]),b.FilterGroups=ko.observableArray([]),b.AddFilterGroup=function(c){var d=new filterGroupViewModel({parent:a.parent,AndOr:c.AndOr,options:a.options});return b.FilterGroups.push(d),d},b.RemoveFilterGroup=function(a){b.FilterGroups.remove(a)},b.AddFilter=function(c,d){c=c||{};var f=ko.observableArray([]);c.Value1&&f.push({id:c.Value1,text:c.Value1}),c.Value2&&f.push({id:c.Value2,text:c.Value2});var g=ko.observable();g.subscribe(function(b){b&&b.hasForeignKey&&ajaxcall({url:a.options.apiUrl,data:{method:"/ReportApi/GetLookupList",model:JSON.stringify({fieldId:b.fieldId})}}).done(function(b){b.result&&(b=b.result),ajaxcall({type:"POST",url:a.options.lookupListUrl,data:JSON.stringify({lookupSql:b.sql,connectKey:b.connectKey})}).done(function(a){a.result&&(a=a.result),f(a)})})}),c.FieldId&&g(a.parent.FindField(c.FieldId)),b.Filters.push({AndOr:ko.observable(d?" AND ":c.AndOr),Field:g,Operator:ko.observable(c.Operator),Value:ko.observable(c.Value1),Value2:ko.observable(c.Value2),LookupList:f,Apply:ko.observable(!(null!=c.Apply)||c.Apply),IsFilterOnFly:!(!0!==d)})},b.RemoveFilter=function(a){b.Filters.remove(a)}}var manageAccess=function(a){return{clientId:ko.observable(),users:_.map(a.users||[],function(a){return{selected:ko.observable(!1),value:ko.observable(a)}}),userRoles:_.map(a.userRoles||[],function(a){return{selected:ko.observable(!1),value:ko.observable(a)}}),viewOnlyUsers:_.map(a.users||[],function(a){return{selected:ko.observable(!1),value:ko.observable(a)}}),viewOnlyUserRoles:_.map(a.userRoles||[],function(a){return{selected:ko.observable(!1),value:ko.observable(a)}}),getAsList:function(a){var b="";return _.forEach(a,function(a){a.selected()&&(b+=(b?",":"")+a.value())}),b},setupList:function(a,b){_.forEach(a,function(a){0<=b.indexOf(a.value())?a.selected(!0):a.selected(!1)})}}},reportViewModel=function(a){var b=this;// List of fields to show in First List to choose from
// List of fields selected by user in the First List
// List of fields selected to show in the Second List
// List of fields selected by user in the second list
// Folder selected in start
// Load saved reports
// ui-validation
a=a||{},a.userSettings=a.userSettings||{},a.userId=a.userSettings.currentUserId||"",a.users=a.userSettings.users,a.userRoles=a.userSettings.userRoles,b.currentUserId=a.userSettings.userId,b.currentUserRole=(a.userSettings.currentUserRoles||[]).join(),b.currentUserName=a.userSettings.currentUserName,b.allowAdmin=ko.observable(a.userSettings.allowAdminMode),b.ReportName=ko.observable(),b.ReportType=ko.observable("List"),b.ReportDescription=ko.observable(),b.FolderID=ko.observable(),b.ReportID=ko.observable(),b.Tables=ko.observableArray([]),b.SelectedTable=ko.observable(),b.ChooseFields=ko.observableArray([]),b.ChosenFields=ko.observableArray([]),b.SelectedFields=ko.observableArray([]),b.SelectFields=ko.observableArray([]),b.SelectedField=ko.observable(),b.AdditionalSeries=ko.observableArray([]),b.IncludeSubTotal=ko.observable(!1),b.ShowUniqueRecords=ko.observable(!1),b.AggregateReport=ko.observable(!1),b.SortByField=ko.observable(),b.FilterGroups=ko.observableArray(),b.FilterGroups.subscribe(function(c){c&&0==c.length&&b.FilterGroups.push(new filterGroupViewModel({isRoot:!0,parent:b,options:a}))}),b.FilterGroups([]),b.SaveReport=ko.observable(!0),b.ShowDataWithGraph=ko.observable(!0),b.ShowOnDashboard=ko.observable(!1),b.ReportMode=ko.observable(a.reportMode||"start"),b.Folders=ko.observableArray(),b.SavedReports=ko.observableArray([]),b.SelectedFolder=ko.observable(null),b.CanSaveReports=ko.observable(!0),b.CanManageFolders=ko.observable(!0),b.CanEdit=ko.observable(!0),b.ReportResult=ko.observable({HasError:ko.observable(!1),ReportDebug:ko.observable(!1),Exception:ko.observable(),Warnings:ko.observable(),ReportSql:ko.observable(),ReportData:ko.observable(null)}),b.pager=new pagerViewModel,b.currentSql=ko.observable(),b.currentConnectKey=ko.observable(),b.adminMode=ko.observable(!1),b.x=ko.observable(0),b.y=ko.observable(0),b.width=ko.observable(3),b.height=ko.observable(2),b.adminMode.subscribe(function(a){b.LoadAllSavedReports(),a?(b._cansavereports=b.CanSaveReports(),b.SaveReport(!0),b.CanSaveReports(!0)):b.CanSaveReports(b._cansavereports)}),b.manageAccess=manageAccess(a),b.pager.currentPage.subscribe(function(){b.ExecuteReportQuery(b.currentSql(),b.currentConnectKey())}),b.createNewReport=function(){b.clearReport(),b.ReportMode("generate")},b.ReportType.subscribe(function(a){"List"==a?b.AggregateReport(!1):b.AggregateReport(!0)}),b.setReportType=function(a){b.ReportType(a)},b.cancelCreateReport=function(){window.abp.message.confirm("Are you sure you would like to cancel editing this Report?",null,c=>{c&&(b.clearReport(),a.reportWizard.modal("hide"),b.ReportMode("start"))})},b.FlyFilters=ko.computed(function(){var a=[];return _.forEach(b.FilterGroups(),function(b){_.forEach(b.Filters(),function(b){b.IsFilterOnFly&&a.push(b)})}),a}),b.enabledFields=ko.computed(function(){return _.filter(b.SelectedFields(),function(a){return!a.disabled()})}),b.scheduleBuilder=new scheduleBuilder,b.ManageFolder={FolderName:ko.observable(),IsNew:ko.observable(!1),newFolder:function(){b.ManageFolder.IsNew(!0),b.ManageFolder.FolderName(""),$("#folderModal").modal("show")},editFolder:function(){return null==b.SelectedFolder()?void window.abp.notify.error("Please choose a folder first"):0==b.SelectedFolder().Id?void window.abp.notify.error("Cannot edit Default folder"):void(b.ManageFolder.IsNew(!1),b.ManageFolder.FolderName(b.SelectedFolder().FolderName),$("#folderModal").modal("show"))},saveFolder:function(){if(""==b.ManageFolder.FolderName())return void window.abp.notify.error("Please enter a Folder Name");var c=b.ManageFolder.IsNew()?0:b.SelectedFolder().Id;return 0==_.filter(b.Folders(),function(a){return a.FolderName.toLowerCase()==b.ManageFolder.FolderName().toLowerCase()&&(0==c||0!=c&&a.Id!=c)}).length?void ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/SaveFolder",model:JSON.stringify({folderId:c,folderName:b.ManageFolder.FolderName()})}}).done(function(a){if(a.result&&(a=a.result),b.ManageFolder.IsNew())b.Folders.push({Id:a,FolderName:b.ManageFolder.FolderName()});else{var c=b.SelectedFolder();b.Folders.remove(b.SelectedFolder()),c.FolderName=b.ManageFolder.FolderName(),b.Folders.push(c)}$("#folderModal").modal("hide")}):(window.abp.notify.error("Folder name is already in use, please choose a different Folder Name"),!1)},deleteFolder:function(){return null==b.SelectedFolder()?void window.abp.notify.error("Please choose a folder first"):0==b.SelectedFolder().Id?void window.abp.notify.error("Cannot delete Default folder"):void window.abp.message.confirm("Are you sure you want to delete this Folder?\n\nWARNING: Deleting a folder will delete all reports and this action cannot be undone.",null,c=>{c&&ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/DeleteFolder",model:JSON.stringify({folderId:b.SelectedFolder().Id})}}).done(function(){b.Folders.remove(b.SelectedFolder()),b.SelectedFolder(null)})})}},b.reportsInFolder=ko.computed(function(){return null==b.SelectedFolder()?[]:_.filter(b.SavedReports(),function(a){return a.folderId==b.SelectedFolder().Id})}),b.clearReport=function(){b.ReportName(""),b.ReportDescription(""),b.ReportType("List"),b.FolderID(null==b.SelectedFolder()?0:b.SelectedFolder().Id),b.ChosenFields([]),b.SelectedTable(null),b.SelectedFields([]),b.SelectFields([]),b.SelectedField(null),b.IncludeSubTotal(!1),b.ShowUniqueRecords(!1),b.AggregateReport(!1),b.SortByField(null),b.FilterGroups([]),b.ReportID(0),b.SaveReport(b.CanSaveReports()),b.scheduleBuilder.clear()},b.SelectedTable.subscribe(function(c){return null==c?void b.ChooseFields([]):void// Get fields for Selected Table
ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/GetFields",model:JSON.stringify({tableId:c.tableId,includeDoNotDisplay:!1})}}).done(function(a){a.result&&(a=a.result);var d=_.map(a,function(a){var d=_.filter(b.SelectedFields(),function(b){return b.fieldId==a.fieldId});return 0<d.length?d[0]:(a.tableName=c.tableName,b.setupField(a))});b.ChooseFields(d)})}),b.MoveChosenFields=function(){// Move chosen fields to selected fields
_.forEach(b.ChosenFields(),function(a){0<_.filter(b.SelectedFields(),function(b){return b.fieldId==a.fieldId}).length?window.abp.notify.error(a.fieldName+" is already Selected"):b.SelectedFields.push(a)})},b.MoveAllFields=function(){// Move chosen fields to selected fields
_.forEach(b.ChooseFields(),function(a){0===_.filter(b.SelectedFields(),function(b){return b.fieldId==a.fieldId}).length&&b.SelectedFields.push(a)})},b.RemoveSelectedFields=function(){_.forEach(b.ChooseFields(),function(a){b.SelectedFields.remove(a)})},b.isFormulaField=ko.observable(!1),b.formulaFields=ko.observableArray([]),b.formulaFieldLabel=ko.observable(""),b.formulaDataFormat=ko.observable(""),b.formulaOnlyHasDateFields=ko.computed(function(){var a=b.formulaFields();if(0>=a.length)return!1;var c=!0;return _.forEach(a,function(a){if(!a.setupFormula.isParenthesesStart()&&!a.setupFormula.isParenthesesEnd()&&!a.setupFormula.isConstantValue()&&a.fieldType&&0>a.fieldType.indexOf("Date"))return c=!1,!1}),c}),b.getEmptyFormulaField=function(){return{tableName:"Custom",fieldName:b.formulaFieldLabel()||"Custom",fieldFormat:b.formulaDataFormat()||"String",fieldType:"Custom",aggregateFunction:"",filterOnFly:!1,disabled:!1,groupInGraph:!1,hideInDetail:!1,fieldAggregate:["Group","Count"],fieldAggregateWithDrilldown:["Group","Count"],isFormulaField:!0,hasForeignKey:!1,fieldFilter:["=","<>",">=",">","<","<="],formulaItems:b.formulaFields()}},b.selectedFieldsCanFilter=ko.computed(function(){return _.filter(b.SelectedFields(),function(a){return!a.isFormulaField()})}),b.clearFormulaField=function(){b.formulaFields([]),b.formulaFieldLabel(""),b.formulaDataFormat("String")},b.isFormulaField.subscribe(function(){b.clearFormulaField()}),b.saveFormulaField=function(){if(0==b.formulaFields().length)return void window.abp.notify.error("Please select some items for the Custom Field");if(!b.validateReport())return void window.abp.notify.error("Please correct validation issues");var a=b.getEmptyFormulaField();b.SelectedFields.push(b.setupField(a)),b.clearFormulaField(),b.isFormulaField(!1)},b.showFormulaOperation=function(a){var c=b.formulaFields().length;return!(1>=c||a==c-1)&&!(b.formulaFields()[a+1].setupFormula.isParenthesesEnd()||b.formulaFields()[a].setupFormula.isParenthesesStart())},b.addFormulaParentheses=function(){if(!(0>=b.formulaFields().length)&&!(b.formulaFields()[0].setupFormula.isParenthesesStart()&&b.formulaFields()[b.formulaFields().length-1].setupFormula.isParenthesesEnd())){var a=b.getEmptyFormulaField(),c=b.setupField(Object.assign({},a)),d=b.setupField(Object.assign({},a));c.setupFormula.isParenthesesStart(!0),d.setupFormula.isParenthesesEnd(!0),b.formulaFields.splice(0,0,c),b.formulaFields.push(d)}},b.addFormulaConstantValue=function(){var a=b.getEmptyFormulaField(),c=b.setupField(Object.assign({},a));c.setupFormula.isConstantValue(!0),b.formulaFields.push(c)},b.isFieldValidForYAxis=function(a,c){return!(0<a&&"Bar"==b.ReportType()&&0>["Int","Double","Money"].indexOf(c))},b.isChart=ko.computed(function(){return 0>["List","Summary"].indexOf(b.ReportType())}),b.isFieldValidForSubGroup=function(a,b){return!(0<a&&0>["Int","Double","Money"].indexOf(b))},b.canDrilldown=ko.computed(function(){return 0>["List"].indexOf(b.ReportType())}),b.dateFields=ko.computed(function(){return _.filter(b.SelectedFields(),function(a){return"DateTime"==a.fieldType})}),b.canAddSeries=ko.computed(function(){var a=0<b.dateFields().length&&0<=["Bar","Line"].indexOf(b.ReportType()),c=0<_.filter(b.FilterGroups(),function(a){return 0<_.filter(a.Filters(),function(a){return"range"==a.Operator()&&a.Value()&&0==a.Value().indexOf("This")}).length}).length;return a&&c}),b.canAddSeries.subscribe(function(a){a||b.AdditionalSeries([])}),b.AddSeries=function(a){function c(a){"This Year"==a?f(["Last Year","2 Years ago","3 Years ago","4 Years ago","5 Years ago"]):"This Month"==a?f(["Last Month","2 Months ago","3 Months ago","4 Months ago","5 Months ago"]):"This Week"==a?f(["Last Week","2 Weeks ago","3 Weeks ago","4 Weeks ago","5 Weeks ago"]):f([])}a=a||{};var d=ko.observable();a.FieldId?d(b.FindField(a.FieldId)):d(b.dateFields()[0]);var f=ko.observableArray([]);_.forEach(b.FilterGroups,function(a){_.forEach(a.Filters(),function(a){if(a.Field().FieldId==d().FieldId)return c(a.Value()),a.Value.subscribe(function(a){c(a)}),!1})}),b.AdditionalSeries.push({Field:d,Operator:ko.observable("Range"),Value:ko.observable(a.Value),Range:f})},b.canMoveUp=function(){// can move up only if one item is selected and it's not at the top
return!!(1==b.SelectFields().length&&1<=b.SelectedFields.indexOf(b.SelectFields()[0]))},b.canMoveDown=function(){// can move up only if one item is selected and it's not at the top
return!!(1==b.SelectFields().length&&b.SelectedFields.indexOf(b.SelectFields()[0])<b.SelectedFields().length-1)},b.MoveUp=function(){if(b.canMoveUp()){var a=b.SelectFields()[0],c=b.SelectedFields.indexOf(a);if(1<=c){var d=b.SelectedFields();b.SelectedFields.splice(c-1,2,d[c],d[c-1])}}},b.MoveDown=function(){if(b.canMoveDown()){var a=b.SelectFields()[0],c=b.SelectedFields.indexOf(a),d=b.SelectedFields();c<d.length-1&&b.SelectedFields.splice(c,2,d[c+1],d[c])}},b.RemoveField=function(a){b.SelectedFields.remove(a)},b.RemoveSeries=function(a){b.AdditionalSeries.remove(a)},b.FindField=function(a){return _.filter(b.SelectedFields(),function(b){return b.fieldId==a})[0]},b.SaveWithoutRun=function(){b.RunReport(!0)},b.BuildFilterData=function(a){var c=[];return _.forEach(a,function(a){var d=[];_.forEach(a.Filters(),function(c,e){var g=c.Apply()&&c.IsFilterOnFly||!c.IsFilterOnFly?{SavedReportId:b.ReportID(),FieldId:c.Field().fieldId,AndOr:0==e?a.AndOr():c.AndOr(),Operator:c.Operator(),Value1:Array.isArray(c.Value())&&"in"==c.Operator()?c.Value().join(","):0<=c.Operator().indexOf("blank")?"blank":c.Value(),Value2:c.Value2(),Filters:0==e?b.BuildFilterData(a.FilterGroups()):[]}:null;null==g||g.Value1||g.Value2||(g=null),g&&d.push(g)}),c.push({SavedReportId:b.ReportID(),isRoot:a.isRoot,AndOr:a.AndOr(),Filters:d})}),c},b.BuildReportData=function(c){c=c||[];var d=b.BuildFilterData(b.FilterGroups());return{ReportID:b.ReportID(),ReportName:b.ReportName(),ReportDescription:b.ReportDescription(),FolderID:b.FolderID(),SelectedFieldIDs:_.map(b.SelectedFields(),function(a){return a.fieldId}),Filters:d,Series:_.map(b.AdditionalSeries(),function(a){return{SavedReportId:b.ReportID(),FieldId:a.Field().fieldId,Operator:a.Operator(),Value:a.Value()}}),IncludeSubTotals:b.IncludeSubTotal(),ShowUniqueRecords:b.ShowUniqueRecords(),IsAggregateReport:!(0<c.length)&&b.AggregateReport(),ShowDataWithGraph:b.ShowDataWithGraph(),ShowOnDashboard:b.ShowOnDashboard(),SortBy:b.SortByField(),ReportType:b.ReportType(),GroupFunctionList:_.map(b.SelectedFields(),function(a){return{FieldID:a.fieldId,GroupFunc:a.selectedAggregate(),FilterOnFly:a.filterOnFly(),Disabled:a.disabled(),GroupInGraph:a.groupInGraph(),HideInDetail:a.hideInDetail(),IsCustom:a.isFormulaField(),CustomLabel:a.fieldName,DataFormat:a.fieldFormat,CustomFieldDetails:_.map(a.formulaItems(),function(a){return{FieldId:a.fieldId(),IsParenthesesStart:a.isParenthesesStart()||!1,IsParenthesesEnd:a.isParenthesesEnd()||!1,Operation:a.formulaOperation(),ConstantValue:a.constantValue()}})}}),Schedule:b.scheduleBuilder.toJs(),DrillDownRow:c,UserId:b.manageAccess.getAsList(b.manageAccess.users),ViewOnlyUserId:b.manageAccess.getAsList(b.manageAccess.viewOnlyUsers),UserRoles:b.manageAccess.getAsList(b.manageAccess.userRoles),ViewOnlyUserRoles:b.manageAccess.getAsList(b.manageAccess.viewOnlyUserRoles),DataFilters:a.dataFilters}},b.RunReport=function(c){return c=!0===c,b.validateReport()?void ajaxcall({url:a.runReportApiUrl,type:"POST",data:JSON.stringify({method:"/ReportApi/RunReport",SaveReport:!!b.CanSaveReports()&&b.SaveReport(),ReportJson:JSON.stringify(b.BuildReportData()),adminMode:b.adminMode()})}).done(function(d){d.result&&(d=d.result),b.ReportID(d.reportId),b.SaveReport()&&(window.abp.notify.success("Report Saved"),c&&b.LoadAllSavedReports()),c||("execute"==b.ReportMode()||"dashboard"==b.ReportMode()?b.ExecuteReportQuery(d.sql,d.connectKey):a.samePageOnRun?(a.reportWizard.modal("hide"),b.ReportID(d.reportId),b.ExecuteReportQuery(d.sql,d.connectKey),b.ReportMode("execute")):redirectToReport(a.runReportUrl,{reportId:d.reportId,reportName:b.ReportName(),reportDescription:b.ReportDescription(),includeSubTotal:b.IncludeSubTotal(),showUniqueRecords:b.ShowUniqueRecords(),aggregateReport:b.AggregateReport(),showDataWithGraph:b.ShowDataWithGraph(),reportSql:d.sql,connectKey:d.connectKey,reportFilter:JSON.stringify(_.map(b.FlyFilters(),function(a){return ko.toJS(a)})),reportType:b.ReportType(),selectedFolder:null==b.SelectedFolder()?0:b.SelectedFolder().Id}))}):void window.abp.notify.error("Please correct validation issues")},b.ExecuteReportQuery=function(c,d){c&&d&&ajaxcall({url:a.execReportUrl,type:"POST",data:JSON.stringify({reportSql:c,connectKey:d,reportType:b.ReportType(),pageNumber:b.pager.currentPage(),pageSize:b.pager.pageSize(),sortBy:b.pager.sortColumn()||"",desc:b.pager.sortDescending()||!1})}).done(function(e){e.result&&(e=e.result);var f=b.ReportResult();f.HasError(e.HasError),f.Exception(e.Exception),f.Warnings(e.Warnings),f.ReportDebug(e.ReportDebug),f.ReportSql(e.ReportSql),e.ReportData.IsDrillDown=ko.observable(!1),_.forEach(e.ReportData.Rows,function(c){c.DrillDownData=ko.observable(null),c.pager=new pagerViewModel({pageSize:10}),c.sql="",c.connectKey="",c.changeSort=function(a){return c.pager.changeSort(a),c.execute(),!1},c.isExpanded=ko.observable(!1),c.execute=function(){""==c.sql||ajaxcall({url:a.execReportUrl,type:"POST",data:JSON.stringify({reportSql:c.sql,connectKey:c.connectKey,reportType:"List",pageNumber:c.pager.currentPage(),pageSize:c.pager.pageSize(),sortBy:c.pager.sortColumn()||"",desc:c.pager.sortDescending()||!1})}).done(function(a){a.result&&(a=a.result),a.ReportData.IsDrillDown=ko.observable(!0),c.DrillDownData(a.ReportData),c.pager.totalRecords(a.Pager.TotalRecords),c.pager.pages(a.Pager.TotalPages)})},c.expand=function(){// load drill down data
ajaxcall({url:a.runReportApiUrl,type:"POST",data:JSON.stringify({method:"/ReportApi/RunDrillDownReport",SaveReport:!1,ReportJson:JSON.stringify(b.BuildReportData(c.Items)),adminMode:b.adminMode()})}).done(function(a){a.result&&(a=a.result),c.sql=a.sql,c.connectKey=a.connectKey,c.execute()}),c.isExpanded(!0)},c.pager.currentPage.subscribe(function(){c.execute()}),c.collapse=function(){c.isExpanded(!1)},c.toggle=function(){c.isExpanded()?c.collapse():c.expand()}}),f.ReportData(e.ReportData),b.pager.totalRecords(e.Pager.TotalRecords),b.pager.pages(e.Pager.TotalPages),b.currentSql(c),b.currentConnectKey(d),e.Warnings&&toastr.info("Note: "+e.Warnings),b.isChart()&&(google.charts.load("current",{packages:["corechart","geochart"]}),google.charts.setOnLoadCallback(b.DrawChart))})},b.ExpandAll=function(){_.forEach(b.ReportResult().ReportData().Rows,function(a){a.expand()})},b.CollapseAll=function(){_.forEach(b.ReportResult().ReportData().Rows,function(a){a.collapse()})},b.DrawChart=function(){if(b.isChart()){// Create the data table.
var a=b.ReportResult().ReportData(),d=new google.visualization.DataTable,f=[],g=[];_.forEach(a.Columns,function(a,c){var e=b.SelectedFields()[c];0==c?d.addColumn(a.IsNumeric?"number":"string",a.ColumnName):e.groupInGraph()?f.push({index:c,column:a.ColumnName}):a.IsNumeric&&g.push({index:c,column:a.ColumnName})}),0==f.length&&_.forEach(a.Columns,function(a,b){0<b&&a.IsNumeric&&d.addColumn(a.IsNumeric?"number":"string",a.ColumnName)});var h=[],i=[];_.forEach(a.Rows,function(a){var b=[];_.forEach(a.Items,function(a,c){if(0==c)0<f.length?(b=_.filter(h,function(b){return b[0]==a.Value}),0<b.length?(h=h.filter(function(b){return b[0]!=a.Value}),b=b[0]):b.push(a.Column.IsNumeric?parseInt(a.Value):a.Value)):b.push(a.Column.IsNumeric?parseInt(a.Value):a.Value);else if(0<f.length){var e=_.filter(f,function(a){return a.index==c});1==e.length?0==_.filter(i,function(b){return b==a.Value}).length&&(i.push(a.Value),_.forEach(g,function(b,c){d.addColumn("number",a.Value+(0==c?"":"-"+c))})):a.Column.IsNumeric&&b.push(a.Column.IsNumeric?parseInt(a.Value):a.Value)}else a.Column.IsNumeric&&b.push(a.Column.IsNumeric?parseInt(a.Value):a.Value)}),h.push(b)}),_.forEach(h,function(a){if(a.length!=d.getNumberOfColumns())for(var b=0;b<=d.getNumberOfColumns()-a.length;b++)a.push(0)}),d.addRows(h);// Set chart options
var j={title:b.ReportName(),animation:{startup:!0,duration:1e3,easing:"out"}},k=document.getElementById("chart_div_"+b.ReportID()),l=null;"Pie"==b.ReportType()&&(l=new google.visualization.PieChart(k)),"Bar"==b.ReportType()&&(l=new google.visualization.ColumnChart(k)),"Line"==b.ReportType()&&(l=new google.visualization.LineChart(k)),"Map"==b.ReportType()&&(l=new google.visualization.GeoChart(k)),l.draw(d,j)}},b.loadFolders=function(c){// Load folders
ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/GetFolders",model:JSON.stringify({adminMode:b.adminMode()})}}).done(function(a){if(a.result&&(a=a.result),b.Folders(a),b.SelectedFolder(null),c){var d=_.filter(a,function(a){return a.Id==c});0<d.length&&b.SelectedFolder(d[0])}})},b.setupField=function(a){a.selectedFieldName=a.tableName+" > "+a.fieldName,a.selectedAggregate=ko.observable(a.aggregateFunction),a.filterOnFly=ko.observable(a.filterOnFly),a.disabled=ko.observable(a.disabled),a.groupInGraph=ko.observable(a.groupInGraph),a.hideInDetail=ko.observable(a.hideInDetail),a.fieldAggregateWithDrilldown=a.fieldAggregate.concat("Only in Detail"),a.isFormulaField=ko.observable(a.isFormulaField);var b=[];return _.forEach(a.formulaItems||[],function(a){b.push(new formulaFieldViewModel({fieldId:a.fieldId||0,isParenthesesStart:a.setupFormula?a.setupFormula.isParenthesesStart():a.isParenthesesStart,isParenthesesEnd:a.setupFormula?a.setupFormula.isParenthesesEnd():a.isParenthesesEnd,formulaOperation:a.setupFormula?a.setupFormula.formulaOperation():a.formulaOperation,constantValue:a.setupFormula?a.setupFormula.constantValue():a.constantValue}))}),a.formulaItems=ko.observableArray(b),a.setupFormula=new formulaFieldViewModel,a},b.LoadReport=function(c,d){return ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/LoadReport",model:JSON.stringify({reportId:c})}}).done(function(c){function f(a,c){a&&0!=a.length&&_.forEach(a,function(a){if(!a.FieldId)c=null==c?b.FilterGroups()[0]:c.AddFilterGroup({AndOr:a.AndOr});else if(0>g.indexOf(a.FieldId)){var d=0<_.filter(b.SelectedFields(),function(b){return!0==b.filterOnFly()&&b.fieldId==a.FieldId}).length;d&&g.push({fieldId:a.FieldId}),null==c&&(c=b.FilterGroups()[0]),c.AddFilter(a,d)}f(a.Filters,c)})}c.result&&(c=c.result),b.ReportID(c.ReportID),b.ReportType(c.ReportType),b.ReportName(c.ReportName),b.ReportDescription(c.ReportDescription),b.FolderID(c.FolderID),_.forEach(c.SelectedFields,function(a){a=b.setupField(a)}),b.SelectedFields(c.SelectedFields),b.ChosenFields([]),b.SelectFields([]),b.SelectedField(null),b.manageAccess.setupList(b.manageAccess.users,c.UserId||""),b.manageAccess.setupList(b.manageAccess.userRoles,c.UserRoles||""),b.manageAccess.setupList(b.manageAccess.viewOnlyUserRoles,c.ViewOnlyUserRoles||""),b.manageAccess.setupList(b.manageAccess.viewOnlyUsers,c.ViewOnlyUserId||""),b.IncludeSubTotal(c.IncludeSubTotals),b.ShowUniqueRecords(c.ShowUniqueRecords),b.AggregateReport(c.IsAggregateReport),b.ShowDataWithGraph(c.ShowDataWithGraph),b.ShowOnDashboard(c.ShowOnDashboard),b.SortByField(c.SortBy),b.CanEdit((!a.clientId||c.ClientId==a.clientId)&&(!a.userId||c.UserId==a.userId)||b.adminMode()),b.FilterGroups([]),b.AdditionalSeries([]),b.scheduleBuilder.fromJs(c.Schedule);var g=[];if(!0==d){if(a.reportFilter&&"[]"!=a.reportFilter){// get fields on the fly submitted by user before
var h=JSON.parse(a.reportFilter);_.forEach(h,function(a){var c=_.filter(g,function(b){return b.fieldId==a.Field.fieldId});0<c.length&&(a.FieldId=a.Field.fieldId,a.Value1=a.Value,g.push(c[0]),b.FilterGroups()[0].AddFilter(a,!0))})}f(c.Filters)}else f(c.Filters);_.forEach(c.Series,function(a){b.AddSeries(a)}),b.SaveReport(!d&&b.CanEdit()),("execute"==b.ReportMode()||"dashboard"==b.ReportMode())&&b.ExecuteReportQuery(a.reportSql,a.reportConnect)})},b.LoadAllSavedReports=function(){ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/GetSavedReports",model:JSON.stringify({adminMode:b.adminMode()})}}).done(function(c){c.result&&(c=c.result),_.forEach(c,function(c){c.runMode=!1,c.openReport=function(){return b.clearReport(),b.LoadReport(c.reportId).done(function(){c.runMode?(b.SaveReport(!1),b.RunReport(),c.runMode=!1):b.ReportMode("generate")})},c.copyReport=function(){c.openReport().done(function(){b.ReportID(0),b.ReportName("Copy of "+b.ReportName()),b.CanEdit(!0),b.SaveReport(!0)})},c.runReport=function(){c.runMode=!0,c.openReport()},c.deleteReport=function(){window.abp.message.confirm("Are you sure you would like to Delete this Report?",null,d=>{d&&ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/DeleteReport",model:JSON.stringify({reportId:c.reportId})}}).done(function(){b.SavedReports.remove(c)})})},0<a.reportId&&c.reportId==a.reportId&&(c.openReport(),a.reportWizard.modal("show"))}),b.SavedReports(c)})},"dashboard"!=b.ReportMode()&&(b.LoadAllSavedReports(),ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/CanSaveReports",model:"{}"}}).done(function(a){a.result&&(a=a.result),a=a||{allowUsersToCreateReports:!0,allowUsersToManageFolders:!0},b.CanSaveReports(a.allowUsersToCreateReports),b.CanManageFolders(a.allowUsersToManageFolders)})),b.changeSort=function(a){return b.pager.changeSort(a),b.ExecuteReportQuery(b.currentSql(),b.currentConnectKey()),!1},b.isInputValid=function(a){// first check for custom validation
return(null==$(a).attr("data-notempty")||0!=$(a).children("option").length)&&(a.validity?a.validity.valid:null==$(a).attr("required")||""!=$(a).val());// next try html5 validation if availble
// finally just check for required attr
},b.validateReport=function(){if(null!=a.reportWizard){var c=a.reportWizard.find("input,select"),d=!0;$(".form-group").removeClass("has-error");for(var e=0;e<c.length;e++)b.isInputValid(c[e])||(d=!1,$(c[e]).closest(".form-group").addClass("has-error"));return d}},b.loadTables=function(){// Load tables
ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/GetTables",model:JSON.stringify({adminMode:b.adminMode()})}}).done(function(a){a.result&&(a=a.result),b.Tables(a)})},b.init=function(a,c){return c?void $("#noaccountModal").modal("show"):void(b.loadFolders(a),b.loadTables())}},dashboardViewModel=function(a){var b=this;b.dashboards=ko.observableArray(a.dashboards||[]),b.adminMode=ko.observable(!1),b.currentUserId=a.userId,b.currentUserRole=(a.currentUserRole||[]).join(),b.reportsAndFolders=ko.observableArray([]),b.allowAdmin=ko.observable(a.allowAdmin);var c=0<a.dashboardId?_.find(b.dashboards(),{id:a.dashboardId})||{name:"",description:""}:0<b.dashboards().length?b.dashboards()[0]:{name:"",description:""};b.dashboard={Id:ko.observable(c.id),Name:ko.observable(c.name),Description:ko.observable(c.description),manageAccess:manageAccess(a)},b.currentDashboard=ko.observable(c),b.selectDashboard=ko.observable(c.id),b.selectDashboard.subscribe(function(a){a!=b.currentDashboard().id&&(window.location=window.location.href.split("?")[0]+"?id="+a)}),b.newDashboard=function(){b.dashboard.Id(0),b.dashboard.Name(""),b.dashboard.Description(""),b.dashboard.manageAccess.setupList(b.dashboard.manageAccess.users,""),b.dashboard.manageAccess.setupList(b.dashboard.manageAccess.userRoles,""),b.dashboard.manageAccess.setupList(b.dashboard.manageAccess.viewOnlyUserRoles,""),b.dashboard.manageAccess.setupList(b.dashboard.manageAccess.viewOnlyUsers,""),_.forEach(b.reportsAndFolders(),function(a){_.forEach(a.reports,function(a){a.selected(!1)})})},b.editDashboard=function(){b.dashboard.Id(b.currentDashboard().id),b.dashboard.Name(b.currentDashboard().name),b.dashboard.Description(b.currentDashboard().description),b.dashboard.manageAccess.setupList(b.dashboard.manageAccess.users,b.currentDashboard().userId||""),b.dashboard.manageAccess.setupList(b.dashboard.manageAccess.userRoles,b.currentDashboard().userRoles||""),b.dashboard.manageAccess.setupList(b.dashboard.manageAccess.viewOnlyUserRoles,b.currentDashboard().viewOnlyUserRoles||""),b.dashboard.manageAccess.setupList(b.dashboard.manageAccess.viewOnlyUsers,b.currentDashboard().viewOnlyUserId||"");var a=(b.currentDashboard().selectedReports||"").split(",");_.forEach(b.reportsAndFolders(),function(b){_.forEach(b.reports,function(b){b.selected(0<=a.indexOf(b.reportId.toString()))})})},b.saveDashboard=function(){if($(".form-group").removeClass("has-error"),!b.dashboard.Name())return $("#add-dash-name").closest(".form-group").addClass("has-error"),!1;var c="";_.forEach(b.reportsAndFolders(),function(a){_.forEach(a.reports,function(a){a.selected()&&(c+=(c?",":"")+a.reportId)})});var d={id:b.dashboard.Id()||0,name:b.dashboard.Name(),description:b.dashboard.Description(),selectedReports:c,userIdAccess:b.dashboard.manageAccess.getAsList(b.dashboard.manageAccess.users),viewOnlyUserId:b.dashboard.manageAccess.getAsList(b.dashboard.manageAccess.viewOnlyUsers),userRolesAccess:b.dashboard.manageAccess.getAsList(b.dashboard.manageAccess.userRoles),viewOnlyUserRoles:b.dashboard.manageAccess.getAsList(b.dashboard.manageAccess.viewOnlyUserRoles),adminMode:b.adminMode()};return ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/SaveDashboard",model:JSON.stringify(d)}}).done(function(a){a.result&&(a=a.result),window.abp.notify.success("Dashboard saved successfully"),setTimeout(function(){window.location=window.location.href.split("?")[0]+"?id="+a.id},500)}),!0},b.deleteDashboard=function(){window.abp.message.confirm("Are you sure you would like to Delete this Dashboard?",null,c=>{c&&ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/DeleteDashboard",model:JSON.stringify({id:b.currentDashboard().id,adminMode:b.adminMode()})}}).done(function(){window.abp.notify.success("Dashboard deleted successfully"),setTimeout(function(){window.location=window.location.href.split("?")[0]},500)})})},b.reports=ko.observableArray([]);var d=0;_.forEach(a.reports,function(c){var e=new reportViewModel({runReportUrl:a.runReportUrl,execReportUrl:a.execReportUrl,reportWizard:a.reportWizard,lookupListUrl:a.lookupListUrl,runReportApiUrl:a.runReportApiUrl,apiUrl:a.apiUrl,reportFilter:c.reportFilter,reportMode:"dashboard",reportSql:c.reportSql,reportId:c.reportId,reportConnect:c.connectKey,users:a.users,userRoles:a.userRoles});e.x=ko.observable(c.x),e.y=ko.observable(c.y),e.width=ko.observable(c.width),e.height=ko.observable(c.height),e.panelStyle="panel-"+(0==d?"default":1==d?"info":2==d?"warning":"danger"),d=3==d?0:d+1,b.reports.push(e),e.LoadReport(c.reportId,!0),e.showFlyFilters=ko.observable(!1),e.toggleFlyFilters=function(){e.showFlyFilters(!e.showFlyFilters())}}),b.drawChart=function(){_.forEach(b.reports(),function(a){a.DrawChart()})},b.updatePosition=function(c){ajaxcall({url:a.apiUrl,noBlocking:!0,data:{method:"/ReportApi/UpdateDashboardReportPosition",model:JSON.stringify({x:c.x,y:c.y,width:c.width,height:c.height,dashboardId:b.currentDashboard().id,reportId:c.id})}})},b.init=function(){return $.when(function(){return ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/GetSavedReports",model:JSON.stringify({adminMode:b.adminMode()})}})}(),function(){return ajaxcall({url:a.apiUrl,data:{method:"/ReportApi/GetFolders",model:JSON.stringify({adminMode:b.adminMode()})}})}()).done(function(a,c){var d=[];c[0].result&&(c[0]=c[0].result),a[0].result&&(a[0]=a[0].result),_.forEach(c[0],function(b){var c=_.filter(a[0],{folderId:b.Id});d.push({folderId:b.Id,folder:b.FolderName,reports:_.map(c,function(a){return{reportId:a.reportId,reportName:a.reportName,reportDescription:a.reportDescription,reportType:a.reportType,selected:ko.observable(!1)}})})}),b.reportsAndFolders(d)})},b.adminMode.subscribe(function(){b.init()})};module.exports={pagerViewModel,formulaFieldViewModel,scheduleBuilder,filterGroupViewModel,manageAccess,reportViewModel,dashboardViewModel};
function Amar(){alert("amar")}function AppViewModel1(){this.firstName1="fname_ko_1",this.lastName1="lname_ko_1"}function AppViewModel2(){this.firstName2="fname_ko_2",this.lastName2="lname_ko_2"}$(document).ready(function(){console.log("Jquery loaded"),$(".btn").css("border","3px solid red")});function Ko1(){ko.applyBindings(new AppViewModel1)}function Ko2(){ko.applyBindings(new AppViewModel2)}module.exports={Ko1,Ko2,Amar};
